<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ê°„í˜¸ì‚¬ ë°ì´í„° ì¡°ì • í˜ì´ì§€</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1500px;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            font-size: 13px;
        }
        th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
        }
        .action-cell {
            white-space: nowrap;
        }
        .action-cell button {
            display: inline-block;
            width: 25px;
            height: 25px;
            padding: 0;
            margin: 0 1px;
            font-size: 12px;
            line-height: 1;
            border: 1px solid #ccc;
            background: #f8f9fa;
            cursor: pointer;
        }
        .action-cell button:hover {
            background: #e9ecef;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .controls .file-upload-wrapper {
            flex-grow: 1;
        }
        .controls button {
            width: auto;
            padding: 10px 20px;
        }
        .history-controls {
            margin-left: auto;
        }
        .history-controls button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            color: #6c757d;
        }
        .history-controls button:disabled {
            color: #d1d1d1;
            cursor: not-allowed;
        }
        input[type="text"], select {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
            font-size: 12px;
        }
        .scrollable-table {
            max-height: 600px;
            overflow-y: auto;
        }
        .date-cell {
            position: relative;
            cursor: pointer;
            padding: 6px;
            min-width: 100px;
        }
        .date-display {
            background: transparent;
            border: none;
            width: 100%;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
        }
        .date-display:disabled {
            cursor: not-allowed;
        }
        .required-field {
            border: 2px solid #ff6b6b !important;
        }
        .required-field:focus {
            border-color: #ff5252 !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 107, 0.25);
        }
        .field-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }
        
        /* ì—‘ì…€ ì—…ë¡œë“œ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: border-color 0.3s ease;
            background: #fafafa;
        }
        
        .upload-area.dragover {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        
        .upload-area i {
            font-size: 2em;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        .upload-progress {
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background: #2196F3;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: block;
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
        }
        
        .validation-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .summary-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .stat {
            font-size: 14px;
        }
        
        .stat.success { color: #28a745; }
        .stat.warning { color: #ffc107; }
        .stat.error { color: #dc3545; }
        
        .error-details {
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .error-item {
            padding: 5px;
            margin: 2px 0;
            background: #fff;
            border-left: 3px solid #dc3545;
            border-radius: 2px;
        }
        
        /* ì—…ë¡œë“œ ë°ì´í„° ìƒíƒœë³„ ìƒ‰ìƒ êµ¬ë¶„ */
        .row-new { background-color: #e8f5e8; }
        .row-update { background-color: #fff3cd; }
        .row-error { background-color: #f8d7da; }
        .row-excluded { opacity: 0.5; }
        
        .template-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .template-btn:hover {
            background: #138496;
        }
        
        .excel-mode {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .excel-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .include-checkbox {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="mySidebar" class="sidebar">
        <button class="sidebar-toggle-btn" onclick="toggleNav()"><i class="fa-solid fa-angles-left"></i></button>
        <a href="/">Wanted ì‘ì„±</a>
        <a href="/roster-view">ê·¼ë¬´í‘œ ë³´ê¸°</a>
        {% if user.is_head_nurse %}
        <a href="/head-nurse-management" class="active">ë¶€ì„œì› ê´€ë¦¬</a>
        <a href="/roster-create">ê·¼ë¬´í‘œ ìƒì„±</a>
        <a href="/roster-configure">ê·¼ë¬´í‘œ ì„¤ì •</a>
        {% endif %}
        <a href="javascript:void(0);" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <div id="main">
        <div class="container">
            <h1>ë¶€ì„œì› ê´€ë¦¬ í˜ì´ì§€</h1>

            <div class="controls">
                <div class="file-upload-wrapper">
                    <button onclick="downloadTemplate()" class="template-btn">ğŸ“¥ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                    <div class="upload-area" id="upload-area">
                        <input type="file" id="excel-upload" accept=".xlsx, .xls" style="display:none;">
                        <div class="upload-content">
                            <i class="fa fa-cloud-upload"></i>
                            <p>ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ <button onclick="document.getElementById('excel-upload').click()" style="border:none; background:none; color:#2196F3; cursor:pointer; text-decoration:underline;">íŒŒì¼ ì„ íƒ</button></p>
                            <small>ì§€ì› í˜•ì‹: .xlsx, .xls (ìµœëŒ€ 10MB)</small>
                        </div>
                    </div>
                    <div class="upload-progress" id="upload-progress" style="display:none;">
                        <div class="progress-bar" id="progress-bar"></div>
                        <span class="progress-text" id="progress-text">ì—…ë¡œë“œ ì¤‘... 0%</span>
                    </div>
                </div>
                <button id="add-nurse-button" onclick="addNurse()">ë¶€ì„œì› ì¶”ê°€</button>
                <button id="edit-button" onclick="toggleEdit(true)">ìˆ˜ì •</button>
                <button id="save-button" onclick="saveChanges()" disabled>ì €ì¥</button>
                <div class="history-controls">
                    <button id="undo-button" onclick="undo()" disabled><i class="fa-solid fa-rotate-left"></i></button>
                    <button id="redo-button" onclick="redo()" disabled><i class="fa-solid fa-rotate-right"></i></button>
                </div>
            </div>

            <!-- ì—‘ì…€ ê²€ì¦ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            <div class="validation-summary" id="validation-summary" style="display:none;">
                <div class="summary-stats">
                    <span class="stat success">âœ… ì„±ê³µ: <strong id="success-count">0</strong>ê±´</span>
                    <span class="stat warning">âš ï¸ ë®ì–´ì“°ê¸°: <strong id="overwrite-count">0</strong>ê±´</span>
                    <span class="stat error">âŒ ì˜¤ë¥˜: <strong id="error-count">0</strong>ê±´</span>
                    <span class="stat info" id="new-groups-stat" style="color: #17a2b8; display: none;">ğŸ¥ ìƒˆ ë³‘ë™: <strong id="new-groups-count">0</strong>ê°œ</span>
                </div>
                <div class="error-details" id="error-details"></div>
                <div class="excel-controls">
                    <button onclick="confirmExcelUpload()" id="confirm-excel-btn" disabled>ğŸ“¥ ì„ íƒëœ ë°ì´í„° ì €ì¥</button>
                    <button onclick="cancelExcelUpload()" id="cancel-excel-btn">âŒ ì·¨ì†Œ</button>
                    <label>
                        <input type="checkbox" id="select-all-excel" onchange="toggleAllExcelRows()"> ëª¨ë‘ ì„ íƒ
                    </label>
                </div>
            </div>

            <div class="scrollable-table">
                <table>
                    <thead>
                        <tr>
                            <th id="excel-include-header" style="display:none;">í¬í•¨</th>
                            <th>ë³‘ë™</th>
                            <th>ID</th>
                            <th>ê³„ì • ID</th>
                            <th>ì´ë¦„</th>
                            <th>ê²½ë ¥ (ë…„)</th>
                            <th>ì§í•¨</th>
                            <th>ì§ì±…</th>
                            <th>ìˆ˜ê°„í˜¸ì‚¬</th>
                            <th>Keep ê°„í˜¸ì‚¬</th>
                            <th>ì´ì›” Off</th>
                            <th>í”„ë¦¬ì…‰í„°</th>
                            <th>ì…ì‚¬ì¼</th>
                            <th>í‡´ì‚¬ì¼</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="nurse-table-body">
                        <!-- Nurse data will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let nurses = [];
        let allNursesInGroup = []; // To populate preceptor dropdown
        let history = [];
        let redoStack = [];
        
        // ì—‘ì…€ ì—…ë¡œë“œ ê´€ë ¨ ë³€ìˆ˜
        let excelData = [];
        let validationResults = [];
        let isExcelMode = false;
        let newGroupsNeeded = [];

        async function fetchNurses() {
            try {
                const response = await fetch('/nurses');
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/login';
                    throw new Error('ê°„í˜¸ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                nurses = await response.json();
                allNursesInGroup = JSON.parse(JSON.stringify(nurses));
                renderTable();
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }

        function pushToHistory() {
            redoStack = []; // Clear redo stack on new action
            history.push(JSON.parse(JSON.stringify(nurses)));
            if (history.length > 5) {
                history.shift();
            }
            document.getElementById('save-button').disabled = false;
            updateHistoryButtons();
        }

        function undo() {
            if (history.length > 0) {
                redoStack.push(JSON.parse(JSON.stringify(nurses)));
                nurses = history.pop();
                renderTable();
                updateHistoryButtons();
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                history.push(JSON.parse(JSON.stringify(nurses)));
                nurses = redoStack.pop();
                renderTable();
                updateHistoryButtons();
            }
        }

        function updateHistoryButtons() {
            document.getElementById('undo-button').disabled = history.length === 0;
            document.getElementById('redo-button').disabled = redoStack.length === 0;
        }

        // ì—‘ì…€ ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        
        // í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        async function downloadTemplate() {
            try {
                const response = await fetch('/nurses/template-download');
                if (!response.ok) {
                    throw new Error('í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ê°„í˜¸ì‚¬_ì •ë³´_í…œí”Œë¦¿.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('âœ… í…œí”Œë¦¿ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error(error);
                alert(`âŒ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ë“œë˜ê·¸ì•¤ë“œë¡­ ë° íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
        function setupDragDrop() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('excel-upload');
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì²˜ë¦¬
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'));
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'));
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleFileUpload(file) {
            // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
            if (file.size > 10 * 1024 * 1024) {
                alert('âŒ íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                alert('âŒ ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (.xlsx, .xlsë§Œ ì§€ì›)');
                return;
            }
            
            // ì§„í–‰ë¥  í‘œì‹œ
            showUploadProgress();
            updateProgress(0, 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                updateProgress(30, 'íŒŒì¼ íŒŒì‹± ì¤‘...');
                
                const response = await fetch('/nurses/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                
                updateProgress(70, 'ë°ì´í„° ê²€ì¦ ì¤‘...');
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const result = await response.json();
                
                updateProgress(100, 'ì™„ë£Œ!');
                
                setTimeout(() => {
                    hideUploadProgress();
                    handleUploadResult(result);
                }, 500);
                
            } catch (error) {
                console.error(error);
                hideUploadProgress();
                alert(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }

        }
        
        // ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ
        function showUploadProgress() {
            document.getElementById('upload-progress').style.display = 'block';
        }
        
        function hideUploadProgress() {
            document.getElementById('upload-progress').style.display = 'none';
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text + ' ' + percent + '%';
        }
        
        // ì—…ë¡œë“œ ê²°ê³¼ ì²˜ë¦¬
        function handleUploadResult(result) {
            if (!result.success) {
                alert(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.error}`);
                return;
            }
            
            excelData = result.data;
            validationResults = result.validation_results;
            newGroupsNeeded = result.new_groups_needed || [];
            
            // ê²€ì¦ ê²°ê³¼ í‘œì‹œ
            displayValidationSummary(result.summary);
            
            // ì—‘ì…€ ëª¨ë“œë¡œ ì „í™˜
            enterExcelMode();
            
            // ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ë Œë”ë§
            renderExcelPreviewTable();
        }
        
        // ê²€ì¦ ê²°ê³¼ ìš”ì•½ í‘œì‹œ
        function displayValidationSummary(summary) {
            document.getElementById('success-count').textContent = summary.valid;
            document.getElementById('overwrite-count').textContent = summary.overwrite;
            document.getElementById('error-count').textContent = summary.error;
            
            // ìƒˆ ê·¸ë£¹ í‘œì‹œ
            if (newGroupsNeeded.length > 0) {
                document.getElementById('new-groups-count').textContent = newGroupsNeeded.length;
                document.getElementById('new-groups-stat').style.display = 'inline';
            } else {
                document.getElementById('new-groups-stat').style.display = 'none';
            }
            
            // ì˜¤ë¥˜ ë° ê²½ê³  ìƒì„¸ í‘œì‹œ
            const errorDetails = document.getElementById('error-details');
            errorDetails.innerHTML = '';
            
            validationResults.forEach((result, index) => {
                const messages = [];
                
                // ì˜¤ë¥˜ ë©”ì‹œì§€
                if (!result.is_valid && result.errors) {
                    messages.push(...result.errors.map(error => `<span style="color: #dc3545;">âŒ ${error}</span>`));
                }
                
                // ê²½ê³  ë©”ì‹œì§€ (ê·¸ë£¹ ìƒíƒœ ë“±)
                if (result.warnings && result.warnings.length > 0) {
                    messages.push(...result.warnings.map(warning => `<span style="color: #28a745;">â„¹ï¸ ${warning}</span>`));
                }
                
                if (messages.length > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = result.is_valid ? 'info-item' : 'error-item';
                    messageDiv.style.padding = '8px';
                    messageDiv.style.margin = '4px 0';
                    messageDiv.style.background = '#fff';
                    messageDiv.style.borderRadius = '4px';
                    messageDiv.style.borderLeft = result.is_valid ? '3px solid #28a745' : '3px solid #dc3545';
                    messageDiv.innerHTML = `
                        <strong>í–‰ ${index + 2}:</strong><br/>
                        ${messages.join('<br/>')}
                    `;
                    errorDetails.appendChild(messageDiv);
                }
            });
            
            document.getElementById('validation-summary').style.display = 'block';
            
            // ì €ì¥ ë²„íŠ¼ í™œì„±í™” (ìœ íš¨í•œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°)
            document.getElementById('confirm-excel-btn').disabled = summary.valid === 0;
        }
        
        // ì—‘ì…€ ëª¨ë“œ ì§„ì…
        function enterExcelMode() {
            isExcelMode = true;
            document.querySelector('.container').classList.add('excel-mode');
            document.getElementById('excel-include-header').style.display = 'table-cell';
            
            // ê¸°ì¡´ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
            document.getElementById('add-nurse-button').disabled = true;
            document.getElementById('edit-button').disabled = true;
            document.getElementById('save-button').disabled = true;
        }
        
        // ì—‘ì…€ ëª¨ë“œ í•´ì œ
        function exitExcelMode() {
            isExcelMode = false;
            document.querySelector('.container').classList.remove('excel-mode');
            document.getElementById('excel-include-header').style.display = 'none';
            document.getElementById('validation-summary').style.display = 'none';
            
            // ê¸°ì¡´ ë²„íŠ¼ë“¤ í™œì„±í™”
            document.getElementById('add-nurse-button').disabled = false;
            document.getElementById('edit-button').disabled = false;
            
            // ë°ì´í„° ì´ˆê¸°í™”
            excelData = [];
            validationResults = [];
            newGroupsNeeded = [];
            
            // ì›ë˜ í…Œì´ë¸”ë¡œ ë³µì›
            renderTable();
        }
        
        // ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ë Œë”ë§
        function renderExcelPreviewTable() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            excelData.forEach((nurse, index) => {
                if (!nurse) return;
                
                const validation = validationResults[index];
                const row = document.createElement('tr');
                
                // í–‰ ìƒíƒœì— ë”°ë¥¸ í´ë˜ìŠ¤ ì ìš©
                if (!validation.is_valid) {
                    row.classList.add('row-error');
                } else if (validation.is_overwrite) {
                    row.classList.add('row-update');
                } else if (validation.is_new_group) {
                    row.classList.add('row-update'); // ìƒˆ ê·¸ë£¹ë„ ë…¸ë€ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                } else {
                    row.classList.add('row-new');
                }
                
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0];
                };
                
                                row.innerHTML = `
                    <td><input type="checkbox" class="include-checkbox" ${validation.is_valid ? 'checked' : ''} ${!validation.is_valid ? 'disabled' : ''} onchange="updateExcelConfirmButton()"></td>
                    <td>${validation.group_name || 'ICU'}</td>
                    <td style="font-size: 11px;">${nurse.nurse_id.substring(0, 8)}...</td>
                    <td><input type="text" class="excel-field" data-field="account_id" value="${nurse.account_id || ''}" ${!validation.is_valid ? 'disabled' : ''}></td>
                    <td><input type="text" class="excel-field" data-field="name" value="${nurse.name}" ${!validation.is_valid ? 'disabled' : ''}></td>
                    <td class="action-cell">
                        <button class="excel-field" data-action="decrease" data-field="experience" ${!validation.is_valid ? 'disabled' : ''}>-</button>
                        <span class="experience-value">${nurse.experience}</span>
                        <button class="excel-field" data-action="increase" data-field="experience" ${!validation.is_valid ? 'disabled' : ''}>+</button>
                    </td>
                    <td><input type="text" class="excel-field" data-field="role" value="${nurse.role || ''}" ${!validation.is_valid ? 'disabled' : ''}></td>
                    <td><input type="text" class="excel-field" data-field="level_" value="${nurse.level_ || ''}" ${!validation.is_valid ? 'disabled' : ''}></td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" class="excel-field" data-field="is_head_nurse" ${nurse.is_head_nurse ? 'checked' : ''} ${!validation.is_valid ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" class="excel-field" data-field="is_night_nurse" ${nurse.is_night_nurse ? 'checked' : ''} ${!validation.is_valid ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="action-cell">
                        <button class="excel-field" data-action="decrease" data-field="personal_off_adjustment" ${!validation.is_valid ? 'disabled' : ''}>-</button>
                        <span class="off-adj-value">${nurse.personal_off_adjustment}</span>
                        <button class="excel-field" data-action="increase" data-field="personal_off_adjustment" ${!validation.is_valid ? 'disabled' : ''}>+</button>
                    </td>
                    <td>
                        <select class="excel-field" data-field="preceptor_id" ${!validation.is_valid ? 'disabled' : ''}>
                            <option value="">ì—†ìŒ</option>
                            ${nurses.filter(n => n.nurse_id !== nurse.nurse_id).map(n => 
                                `<option value="${n.nurse_id}" ${nurse.preceptor_id === n.nurse_id ? 'selected' : ''}>${n.name}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td class="date-cell">
                        <input type="date" class="excel-field date-display" data-field="joining_date" value="${formatDate(nurse.joining_date)}" ${!validation.is_valid ? 'disabled' : ''}>
                    </td>
                    <td class="date-cell">
                        <input type="date" class="excel-field date-display" data-field="resignation_date" value="${formatDate(nurse.resignation_date)}" ${!validation.is_valid ? 'disabled' : ''}>
                    </td>
                    <td class="action-cell">
                        ${validation.is_valid
                            ? (validation.is_new_group 
                                ? '<span style="color: orange;" title="ìƒˆ ë³‘ë™ ìƒì„± ì˜ˆì •">ğŸ¥</span>'
                                : '<span style="color: green;">âœ“</span>')
                            : '<span style="color: red;" title="' + (validation.errors ? validation.errors.join(', ') : 'ì˜¤ë¥˜') + '">âœ—</span>'
                        }
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            addExcelEventListeners();
            updateExcelConfirmButton();
        }
        
        // ì—‘ì…€ ë°ì´í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        function addExcelEventListeners() {
            // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ
            document.querySelectorAll('input.excel-field[type="text"], input.excel-field[type="date"], select.excel-field').forEach(input => {
                input.addEventListener('change', (e) => {
                    const row = e.target.closest('tr');
                    const index = Array.from(row.parentNode.children).indexOf(row);
                    const field = e.target.getAttribute('data-field');
                    
                    if (field === 'joining_date' || field === 'resignation_date') {
                        excelData[index][field] = e.target.value ? new Date(e.target.value).toISOString() : null;
                    } else {
                        excelData[index][field] = e.target.value;
                    }
                });
            });
            
            // ì²´í¬ë°•ìŠ¤
            document.querySelectorAll('input.excel-field[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const row = e.target.closest('tr');
                    const index = Array.from(row.parentNode.children).indexOf(row);
                    const field = e.target.getAttribute('data-field');
                    excelData[index][field] = e.target.checked;
                });
            });
            
            // ìˆ«ì ë²„íŠ¼
            document.querySelectorAll('.excel-field[data-action]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    const index = Array.from(row.parentNode.children).indexOf(row);
                    const field = e.target.getAttribute('data-field');
                    const action = e.target.getAttribute('data-action');
                    
                    if (action === 'increase') {
                        excelData[index][field]++;
                    } else if (action === 'decrease') {
                        if (field === 'experience' && excelData[index][field] <= 1) {
                            return;
                        }
                        excelData[index][field]--;
                    }
                    
                    if(field === 'experience') {
                        row.querySelector('.experience-value').textContent = excelData[index][field];
                    } else if(field === 'personal_off_adjustment') {
                        row.querySelector('.off-adj-value').textContent = excelData[index][field];
                    }
                });
            });
        }
        
        // ëª¨ë“  í–‰ ì„ íƒ/í•´ì œ
        function toggleAllExcelRows() {
            const selectAll = document.getElementById('select-all-excel');
            const checkboxes = document.querySelectorAll('.include-checkbox:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateExcelConfirmButton();
        }
        
        // í™•ì¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateExcelConfirmButton() {
            const checkedBoxes = document.querySelectorAll('.include-checkbox:checked');
            document.getElementById('confirm-excel-btn').disabled = checkedBoxes.length === 0;
        }
        
        // ì—‘ì…€ ë°ì´í„° ì €ì¥ í™•ì¸
        async function confirmExcelUpload() {
            const includeRows = Array.from(document.querySelectorAll('.include-checkbox')).map(cb => cb.checked);
            const selectedCount = includeRows.filter(Boolean).length;
            
            if (selectedCount === 0) {
                alert('âš ï¸ ì €ì¥í•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let confirmMessage = `ì„ íƒëœ ${selectedCount}ê±´ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            if (newGroupsNeeded.length > 0) {
                confirmMessage += `\n\nìƒˆë¡œ ìƒì„±ë  ë³‘ë™: ${newGroupsNeeded.join(', ')}`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const response = await fetch('/nurses/confirm-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: excelData,
                        include_rows: includeRows,
                        new_groups_to_create: newGroupsNeeded
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const result = await response.json();
                alert(`âœ… ${result.message}`);
                
                // ì—‘ì…€ ëª¨ë“œ í•´ì œ ë° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                exitExcelMode();
                fetchNurses();
                
            } catch (error) {
                console.error(error);
                alert(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì—‘ì…€ ì—…ë¡œë“œ ì·¨ì†Œ
        function cancelExcelUpload() {
            if (confirm('ì—‘ì…€ ì—…ë¡œë“œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì—…ë¡œë“œëœ ë°ì´í„°ëŠ” ì‚­ì œë©ë‹ˆë‹¤.')) {
                exitExcelMode();
            }
        }

        function renderTable() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';

            nurses.forEach(nurse => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', nurse.nurse_id);
                if (nurse.is_new) {
                    row.style.backgroundColor = '#e8f5e8';
                }

                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
                };

                row.innerHTML = `
                    <td>ICU</td>
                    <td style="font-size: 11px;">${nurse.nurse_id.substring(0, 8)}...</td>
                    <td><input type="text" class="nurse-field" data-field="account_id" value="${nurse.account_id || ''}" ${nurse.is_new ? '' : 'disabled'} required></td>
                    <td><input type="text" class="nurse-field" data-field="name" value="${nurse.name}" ${nurse.is_new ? '' : 'disabled'}></td>
                    <td class="action-cell">
                        <button class="nurse-field" data-action="decrease" data-field="experience" ${nurse.is_new ? '' : 'disabled'}>-</button>
                        <span class="experience-value">${nurse.experience}</span>
                        <button class="nurse-field" data-action="increase" data-field="experience" ${nurse.is_new ? '' : 'disabled'}>+</button>
                    </td>
                    <td><input type="text" class="nurse-field" data-field="role" value="${nurse.role || ''}" ${nurse.is_new ? '' : 'disabled'}></td>
                    <td><input type="text" class="nurse-field" data-field="level_" value="${nurse.level_ || ''}" ${nurse.is_new ? '' : 'disabled'}></td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" class="nurse-field" data-field="is_head_nurse" ${nurse.is_head_nurse ? 'checked' : ''} ${nurse.is_new ? '' : 'disabled'}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" class="nurse-field" data-field="is_night_nurse" ${nurse.is_night_nurse ? 'checked' : ''} ${nurse.is_new ? '' : 'disabled'}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="action-cell">
                        <button class="nurse-field" data-action="decrease" data-field="personal_off_adjustment" ${nurse.is_new ? '' : 'disabled'}>-</button>
                        <span class="off-adj-value">${nurse.personal_off_adjustment}</span>
                        <button class="nurse-field" data-action="increase" data-field="personal_off_adjustment" ${nurse.is_new ? '' : 'disabled'}>+</button>
                    </td>
                    <td>
                        <select class="nurse-field" data-field="preceptor_id" ${nurse.is_new ? '' : 'disabled'}>
                            <option value="">ì—†ìŒ</option>
                            ${nurses.filter(n => n.nurse_id !== nurse.nurse_id).map(n => 
                                `<option value="${n.nurse_id}" ${nurse.preceptor_id === n.nurse_id ? 'selected' : ''}>${n.name}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td class="date-cell">
                        <input type="date" class="nurse-field date-display" data-field="joining_date" value="${formatDate(nurse.joining_date)}" ${nurse.is_new ? '' : 'disabled'}>
                    </td>
                    <td class="date-cell">
                        <input type="date" class="nurse-field date-display" data-field="resignation_date" value="${formatDate(nurse.resignation_date)}" ${nurse.is_new ? '' : 'disabled'}>
                    </td>
                    <td class="action-cell">
                        ${nurse.is_new 
                            ? `<button onclick="completeAdd('${nurse.nurse_id}')">âœ“</button><button onclick="deleteNurse('${nurse.nurse_id}', true)">âœ—</button>`
                            : `<button class="delete-btn" onclick="deleteNurse('${nurse.nurse_id}')" style="visibility: hidden;">ğŸ—‘</button>`
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });

            addEventListeners();
            
            // ìˆ˜ê°„í˜¸ì‚¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateHeadNurseStatus();
            }, 100);
        }

        function toggleEdit(isEditing, doPushToHistory = true) {
            if(isEditing && doPushToHistory) pushToHistory();

            const fields = document.querySelectorAll('.nurse-field');
            fields.forEach(field => {
                const row = field.closest('tr');
                const nurse = nurses.find(n => n.nurse_id === row.getAttribute('data-id'));
                if (!nurse.is_new) {
                    field.disabled = !isEditing;
                }
            });
            document.querySelectorAll('.delete-btn').forEach(btn => btn.style.visibility = isEditing ? 'visible' : 'hidden');
            
            document.getElementById('edit-button').disabled = isEditing;
            document.getElementById('add-nurse-button').disabled = !isEditing;
            document.getElementById('save-button').disabled = !isEditing || history.length === 0;
        }

        function addNurse() {
            pushToHistory();
            const newNurse = {
                nurse_id: uuid.v4(),
                group_id: "{{ user.group_id }}", // Will be set on the backend
                account_id: '', // í•„ìˆ˜ ì…ë ¥ ì‚¬í•­
                name: "New Nurse",
                experience: 1, // ìµœì†Œ 1ë…„
                role: '', // ì§í•¨
                level_: '', // ì§ì±…
                is_head_nurse: false,
                is_night_nurse: false,
                personal_off_adjustment: 0,
                preceptor_id: null,
                joining_date: null, // ì…ì‚¬ì¼
                resignation_date: null, // í‡´ì‚¬ì¼
                is_new: true
            };
            nurses.push(newNurse);
            renderTable();
        }

        function completeAdd(uuid) {
            pushToHistory();
            const nurse = nurses.find(n => n.nurse_id === uuid);
            if(nurse) {
                delete nurse.is_new;
            }
            renderTable();
        }

        function deleteNurse(uuid, isNew = false) {
            if (!document.getElementById('edit-button').disabled && !isNew) {
                 pushToHistory();
            }
            
            // ë§ˆì§€ë§‰ ìˆ˜ê°„í˜¸ì‚¬ ì‚­ì œ ë°©ì§€
            const nurseToDelete = nurses.find(n => n.nurse_id === uuid);
            if (nurseToDelete && nurseToDelete.is_head_nurse) {
                const headNurses = nurses.filter(n => n.is_head_nurse);
                if (headNurses.length === 1) {
                    alert("âš ï¸ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\në§ˆì§€ë§‰ ìˆ˜ê°„í˜¸ì‚¬ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¶€ì„œì—ëŠ” ë°˜ë“œì‹œ ìµœì†Œ 1ëª…ì˜ ìˆ˜ê°„í˜¸ì‚¬ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }
            }
            
            nurses = nurses.filter(n => n.nurse_id !== uuid);
            renderTable();
            if (!isNew) {
                document.getElementById('save-button').disabled = false;
            }
        }

        async function saveChanges() {
            // ìˆ˜ê°„í˜¸ì‚¬ í•„ìˆ˜ ê²€ì¦ - ë” ìƒì„¸í•œ ë©”ì‹œì§€
            const headNurses = nurses.filter(n => n.is_head_nurse);
            if (headNurses.length === 0) {
                alert("âš ï¸ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\në¶€ì„œì—ëŠ” ë°˜ë“œì‹œ 1ëª… ì´ìƒì˜ ìˆ˜ê°„í˜¸ì‚¬ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\nìµœì†Œ 1ëª…ì˜ ê°„í˜¸ì‚¬ë¥¼ ìˆ˜ê°„í˜¸ì‚¬ë¡œ ì§€ì •í•´ì£¼ì„¸ìš”.");
                return;
            }

            // account_id í•„ìˆ˜ ì…ë ¥ ê²€ì‚¬
            const missingAccountIds = nurses.filter(n => !n.account_id || n.account_id.trim() === '');
            if (missingAccountIds.length > 0) {
                alert("âš ï¸ ëª¨ë“  ê°„í˜¸ì‚¬ì˜ ê³„ì • IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                const response = await fetch('/nurses/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nurses.map(n => {
                        // Clean up temp flags before sending
                        const { is_new, ...nurseData } = n;
                        return nurseData;
                    }))
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                alert("âœ… ë³€ê²½ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                history = [];
                redoStack = [];
                updateHistoryButtons();
                document.getElementById('save-button').disabled = true;
                toggleEdit(false);
                fetchNurses(); // Refresh data from DB

            } catch (error) {
                console.error(error);
                alert(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        function updateHeadNurseStatus() {
            const headNurses = nurses.filter(n => n.is_head_nurse);
            const headNurseCount = headNurses.length;
            
            // ìˆ˜ê°„í˜¸ì‚¬ê°€ 1ëª…ë¿ì¼ ë•Œ í•´ë‹¹ ìˆ˜ê°„í˜¸ì‚¬ ì²´í¬ë°•ìŠ¤ì— ì‹œê°ì  í‘œì‹œ
            if (headNurseCount === 1) {
                const headNurseId = headNurses[0].nurse_id;
                const headNurseRow = document.querySelector(`tr[data-id="${headNurseId}"]`);
                if (headNurseRow) {
                    const checkbox = headNurseRow.querySelector('input[data-field="is_head_nurse"]');
                    if (checkbox) {
                        checkbox.style.boxShadow = '0 0 5px #ff6b6b';
                        checkbox.title = 'ë§ˆì§€ë§‰ ìˆ˜ê°„í˜¸ì‚¬ì…ë‹ˆë‹¤. í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                }
            } else {
                // ìˆ˜ê°„í˜¸ì‚¬ê°€ 2ëª… ì´ìƒì¼ ë•Œ ëª¨ë“  ìˆ˜ê°„í˜¸ì‚¬ ì²´í¬ë°•ìŠ¤ì˜ ê°•ì¡° íš¨ê³¼ ì œê±°
                nurses.forEach(nurse => {
                    if (nurse.is_head_nurse) {
                        const row = document.querySelector(`tr[data-id="${nurse.nurse_id}"]`);
                        if (row) {
                            const checkbox = row.querySelector('input[data-field="is_head_nurse"]');
                            if (checkbox) {
                                checkbox.style.boxShadow = '';
                                checkbox.title = 'ìˆ˜ê°„í˜¸ì‚¬ ì§€ì •';
                            }
                        }
                    }
                });
            }
            
            // í˜ì´ì§€ ìƒë‹¨ì— ìˆ˜ê°„í˜¸ì‚¬ í˜„í™© í‘œì‹œ (ì„ íƒì‚¬í•­)
            console.log(`í˜„ì¬ ìˆ˜ê°„í˜¸ì‚¬: ${headNurseCount}ëª… (${headNurses.map(n => n.name).join(', ')})`);
        }
        
        function addEventListeners() {
            document.querySelectorAll('.nurse-field[data-action]').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (button.disabled) return;
                    pushToHistory();
                    const row = e.target.closest('tr');
                    const nurseId = row.getAttribute('data-id');
                    const nurse = nurses.find(n => n.nurse_id === nurseId);
                    const field = e.target.getAttribute('data-field');
                    const action = e.target.getAttribute('data-action');

                    if (action === 'increase') {
                        nurse[field]++;
                    } else if (action === 'decrease') {
                        if (field === 'experience' && nurse[field] <= 1) {
                            return; // ê²½ë ¥ì€ ìµœì†Œ 1ë…„
                        }
                        nurse[field]--;
                    }
                    
                    if(field === 'experience') {
                        row.querySelector('.experience-value').textContent = nurse[field];
                    } else if(field === 'personal_off_adjustment') {
                        row.querySelector('.off-adj-value').textContent = nurse[field];
                    }
                });
            });

            document.querySelectorAll('input.nurse-field[type="text"], input.nurse-field[type="date"], select.nurse-field').forEach(input => {
                input.addEventListener('change', (e) => {
                    if (input.disabled) return;
                    pushToHistory();
                    const row = e.target.closest('tr');
                    const nurseId = row.getAttribute('data-id');
                    const nurse = nurses.find(n => n.nurse_id === nurseId);
                    const field = e.target.getAttribute('data-field');
                    
                    if (field === 'is_night_nurse') {
                        nurse.is_night_nurse = e.target.value === 'true';
                    } else if (field === 'preceptor_id') {
                         nurse.preceptor_id = e.target.value || null;
                    } else if (field === 'joining_date' || field === 'resignation_date') {
                        // ë‚ ì§œ í•„ë“œëŠ” ISO í˜•ì‹ìœ¼ë¡œ ì €ì¥
                        nurse[field] = e.target.value ? new Date(e.target.value).toISOString() : null;
                    } else {
                        nurse[field] = e.target.value;
                    }
                });
            });

             document.querySelectorAll('input.nurse-field[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (checkbox.disabled) return;
                    
                    const field = e.target.getAttribute('data-field');
                    
                    // ìˆ˜ê°„í˜¸ì‚¬ í† ê¸€ì— ëŒ€í•œ íŠ¹ë³„ ê²€ì¦
                    if (field === 'is_head_nurse') {
                        const currentHeadNurses = nurses.filter(n => n.is_head_nurse);
                        
                        // ë§ˆì§€ë§‰ ìˆ˜ê°„í˜¸ì‚¬ë¥¼ ë„ë ¤ê³  í•˜ëŠ” ê²½ìš°
                        if (e.target.checked === false && currentHeadNurses.length === 1) {
                            e.preventDefault();
                            e.target.checked = true; // ì²´í¬ë¥¼ ë‹¤ì‹œ ì¼œê¸°
                            alert("âš ï¸ ê²½ê³ !\n\në§ˆì§€ë§‰ ìˆ˜ê°„í˜¸ì‚¬ëŠ” í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¶€ì„œì—ëŠ” ë°˜ë“œì‹œ ìµœì†Œ 1ëª…ì˜ ìˆ˜ê°„í˜¸ì‚¬ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\n\në‹¤ë¥¸ ê°„í˜¸ì‚¬ë¥¼ ìˆ˜ê°„í˜¸ì‚¬ë¡œ ì§€ì •í•œ í›„ì— í•´ì œí•˜ì„¸ìš”.");
                            return;
                        }
                        
                        // ìˆ˜ê°„í˜¸ì‚¬ë¥¼ ì¶”ê°€í•˜ëŠ” ê²½ìš° í™•ì¸ ë©”ì‹œì§€
                        if (e.target.checked === true) {
                            const row = e.target.closest('tr');
                            const nurseId = row.getAttribute('data-id');
                            const nurse = nurses.find(n => n.nurse_id === nurseId);
                            const confirmMsg = `"${nurse.name}" ë‹˜ì„ ìˆ˜ê°„í˜¸ì‚¬ë¡œ ì§€ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                            
                            if (!confirm(confirmMsg)) {
                                e.target.checked = false;
                                return;
                            }
                        }
                    }
                    
                    pushToHistory();
                    const row = e.target.closest('tr');
                    const nurseId = row.getAttribute('data-id');
                    const nurse = nurses.find(n => n.nurse_id === nurseId);
                    nurse[field] = e.target.checked;
                    
                    // ìˆ˜ê°„í˜¸ì‚¬ ìƒíƒœ ë³€ê²½ í›„ ì¶”ê°€ ì²˜ë¦¬
                    if (field === 'is_head_nurse') {
                        updateHeadNurseStatus();
                    }
                });
            });
        }

        // Initial render
        document.addEventListener('DOMContentLoaded', () => {
            fetchNurses();
            updateHistoryButtons();
            setupDragDrop(); // ë“œë˜ê·¸ì•¤ë“œë¡­ ì„¤ì •
        });

        function toggleNav() {
            const sidebar = document.getElementById("mySidebar");
            const main = document.getElementById("main");
            const toggleBtn = document.querySelector(".sidebar-toggle-btn i");

            const isOpen = sidebar.style.width === "250px";
            if (isOpen) {
                sidebar.style.width = "0";
                main.style.marginLeft = "0";
                toggleBtn.classList.remove('fa-angles-left');
                toggleBtn.classList.add('fa-angles-right');
            } else {
                sidebar.style.width = "250px";
                main.style.marginLeft = "250px";
                toggleBtn.classList.remove('fa-angles-right');
                toggleBtn.classList.add('fa-angles-left');
            }
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }
    </script>
</body>
</html> 