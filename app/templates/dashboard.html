<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>근무표 만족도 대시보드</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 20px;
        }
        
        .dashboard-header {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .dashboard-header h1 {
            margin: 0 0 20px 0;
            color: #333;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-controls select, .filter-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 16px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #999;
            font-size: 14px;
        }
        
        .chart-container {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .chart-container h2 {
            margin: 0 0 20px 0;
            color: #333;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .individual-table {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .individual-table h2 {
            margin: 0 0 20px 0;
            color: #333;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .analytics-table th,
        .analytics-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .analytics-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .analytics-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .satisfaction-bar {
            width: 100px;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .satisfaction-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }
        
        .satisfaction-fill.low {
            background-color: #f44336;
        }
        
        .satisfaction-fill.medium {
            background-color: #ff9800;
        }
        
        .satisfaction-fill.high {
            background-color: #4CAF50;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="mySidebar" class="sidebar">
        <button class="sidebar-toggle-btn" onclick="toggleNav()"><i class="fa-solid fa-angles-left"></i></button>
        <a href="/">Wanted 작성</a>
        <a href="/roster-view">근무표 보기</a>
        {% if user.is_head_nurse %}
        <a href="/head-nurse-management">부서원 관리</a>
        <a href="/roster-create">근무표 생성</a>
        <a href="/roster-configure">근무표 설정</a>
        <a href="/dashboard" class="active">만족도 대시보드</a>
        {% endif %}
        <a href="javascript:void(0);" onclick="logout()">로그아웃</a>
    </div>

    <div id="main">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>근무표 만족도 대시보드</h1>
                <div class="filter-controls">
                    <label for="yearFilter">년도:</label>
                    <select id="yearFilter" onchange="loadDashboardData()">
                        <option value="">전체</option>
                    </select>
                    
                    <label for="monthFilter">월:</label>
                    <select id="monthFilter" onchange="loadDashboardData()">
                        <option value="">전체</option>
                        <option value="1">1월</option>
                        <option value="2">2월</option>
                        <option value="3">3월</option>
                        <option value="4">4월</option>
                        <option value="5">5월</option>
                        <option value="6">6월</option>
                        <option value="7">7월</option>
                        <option value="8">8월</option>
                        <option value="9">9월</option>
                        <option value="10">10월</option>
                        <option value="11">11월</option>
                        <option value="12">12월</option>
                    </select>
                    
                    <button onclick="loadDashboardData()" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fa fa-refresh"></i> 새로고침
                    </button>
                </div>
            </div>

            <!-- 요약 통계 -->
            <div class="stats-grid" id="summaryStats">
                <div class="loading">데이터를 불러오는 중...</div>
            </div>

            <!-- 차트 섹션 -->
            <div class="chart-container">
                <h2>만족도 분포</h2>
                <div class="chart-wrapper">
                    <canvas id="satisfactionChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>월별 트렌드</h2>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- 개인별 분석 테이블 -->
            <div class="individual-table">
                <h2>개인별 만족도 분석</h2>
                <div class="table-container">
                    <table class="analytics-table" id="individualTable">
                        <thead>
                            <tr>
                                <th>간호사</th>
                                <th>전체 만족도</th>
                                <th>휴무 만족도</th>
                                <th>근무 만족도</th>
                                <th>페어링 만족도</th>
                                <th>요청 수</th>
                                <th>반영된 요청</th>
                                <th>반영률</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="loading">데이터를 불러오는 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let satisfactionChart = null;
        let trendChart = null;

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("mySidebar").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
            
            // 년도 옵션 생성
            const currentYear = new Date().getFullYear();
            const yearFilter = document.getElementById("yearFilter");
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '년';
                yearFilter.appendChild(option);
            }
            
            loadDashboardData();
        });

        function toggleNav() {
            const sidebar = document.getElementById("mySidebar");
            const main = document.getElementById("main");
            const toggleBtn = document.querySelector(".sidebar-toggle-btn i");

            const isOpen = sidebar.style.width === "250px";
            if (isOpen) {
                sidebar.style.width = "0";
                main.style.marginLeft = "0";
                toggleBtn.classList.remove('fa-angles-left');
                toggleBtn.classList.add('fa-angles-right');
            } else {
                sidebar.style.width = "250px";
                main.style.marginLeft = "250px";
                toggleBtn.classList.remove('fa-angles-right');
                toggleBtn.classList.add('fa-angles-left');
            }
        }
        
        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        async function loadDashboardData() {
            const yearFilter = document.getElementById("yearFilter");
            const monthFilter = document.getElementById("monthFilter");
            
            const year = yearFilter.value || null;
            const month = monthFilter.value || null;
            console.log(year, month);
            try {
                // 요약 데이터 로드
                await loadSummaryData(year, month);
                console.log("summary data loaded");
                // 개인별 데이터 로드
                await loadIndividualData(year, month);
                console.log("individual data loaded");
                // 트렌드 데이터 로드
                await loadTrendData();
                console.log("trend data loaded");
            } catch (error) {
                console.error('대시보드 데이터 로드 실패:', error);
                showError('데이터를 불러오는데 실패했습니다.');
            }
        }

        async function loadSummaryData(year, month) {
            let url = '/dashboard/summary';
            const params = new URLSearchParams();
            if (year) params.append('year', year);
            if (month) params.append('month', month);
            if (params.toString()) url += '?' + params.toString();
            
            const response = await fetch(url);
            if (!response.ok) {
                if (response.status === 401) {
                    // 인증 에러인 경우 로그인 페이지로 리다이렉트
                    window.location.href = '/login';
                    return;
                }
                throw new Error('요약 데이터 로드 실패');
            }
            
            const data = await response.json();
            updateSummaryStats(data);
            updateSatisfactionChart(data);
        }

        async function loadIndividualData(year, month) {
            let url = '/dashboard/individual';
            const params = new URLSearchParams();
            if (year) params.append('year', year);
            if (month) params.append('month', month);
            if (params.toString()) url += '?' + params.toString();
            
            const response = await fetch(url);
            if (!response.ok) {
                if (response.status === 401) {
                    // 인증 에러인 경우 로그인 페이지로 리다이렉트
                    window.location.href = '/login';
                    return;
                }
                throw new Error('개인별 데이터 로드 실패');
            }
            
            const data = await response.json();
            updateIndividualTable(data);
        }

        async function loadTrendData() {
            const response = await fetch('/dashboard/trends?months=6');
            if (!response.ok) {
                if (response.status === 401) {
                    // 인증 에러인 경우 로그인 페이지로 리다이렉트
                    window.location.href = '/login';
                    return;
                }
                throw new Error('트렌드 데이터 로드 실패');
            }
            
            const data = await response.json();
            console.log('data', data);
            updateTrendChart(data);
        }

        function updateSummaryStats(data) {
            const statsContainer = document.getElementById("summaryStats");
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>전체 간호사 수</h3>
                    <div class="stat-value">${data.total_nurses}</div>
                    <div class="stat-label">명</div>
                </div>
                <div class="stat-card">
                    <h3>평균 만족도</h3>
                    <div class="stat-value">${data.average_satisfaction.toFixed(1)}%</div>
                    <div class="stat-label">전체 요청 대비</div>
                </div>
                <div class="stat-card">
                    <h3>전체 요청 수</h3>
                    <div class="stat-value">${data.request_statistics.total_requests}</div>
                    <div class="stat-label">개</div>
                </div>
                <div class="stat-card">
                    <h3>반영된 요청</h3>
                    <div class="stat-value">${data.request_statistics.satisfied_requests}</div>
                    <div class="stat-label">개 (${data.request_statistics.satisfaction_rate.toFixed(1)}%)</div>
                </div>
            `;
        }

        function updateSatisfactionChart(data) {
            const ctx = document.getElementById('satisfactionChart').getContext('2d');
            
            if (satisfactionChart) {
                satisfactionChart.destroy();
            }
            
            satisfactionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['휴무 만족도', '근무 만족도', '페어링 만족도'],
                    datasets: [{
                        data: [
                            data.satisfaction_breakdown.off,
                            data.satisfaction_breakdown.shift,
                            data.satisfaction_breakdown.pair
                        ],
                        backgroundColor: [
                            '#4CAF50',
                            '#2196F3',
                            '#FF9800'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const labels = data.map(item => `${item.year}년 ${item.month}월`).reverse();
            const satisfactionData = data.map(item => item.avg_satisfaction).reverse();
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '평균 만족도',
                        data: satisfactionData,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '만족도: ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateIndividualTable(data) {
            const tbody = document.querySelector('#individualTable tbody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">데이터가 없습니다.</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(nurse => `
                <tr>
                    <td>${nurse.nurse_name}</td>
                    <td>
                        <div class="satisfaction-bar">
                            <div class="satisfaction-fill ${getSatisfactionClass(nurse.overall_satisfaction)}" 
                                 style="width: ${nurse.overall_satisfaction}%"></div>
                        </div>
                        ${nurse.overall_satisfaction.toFixed(1)}%
                    </td>
                    <td>
                        <div class="satisfaction-bar">
                            <div class="satisfaction-fill ${getSatisfactionClass(nurse.off_satisfaction)}" 
                                 style="width: ${nurse.off_satisfaction}%"></div>
                        </div>
                        ${nurse.off_satisfaction.toFixed(1)}%
                    </td>
                    <td>
                        <div class="satisfaction-bar">
                            <div class="satisfaction-fill ${getSatisfactionClass(nurse.shift_satisfaction)}" 
                                 style="width: ${nurse.shift_satisfaction}%"></div>
                        </div>
                        ${nurse.shift_satisfaction.toFixed(1)}%
                    </td>
                    <td>
                        <div class="satisfaction-bar">
                            <div class="satisfaction-fill ${getSatisfactionClass(nurse.pair_satisfaction)}" 
                                 style="width: ${nurse.pair_satisfaction}%"></div>
                        </div>
                        ${nurse.pair_satisfaction.toFixed(1)}%
                    </td>
                    <td>${nurse.total_requests}</td>
                    <td>${nurse.satisfied_requests}</td>
                    <td>${nurse.total_requests > 0 ? (nurse.satisfied_requests / nurse.total_requests * 100).toFixed(1) : 0}%</td>
                </tr>
            `).join('');
        }

        function getSatisfactionClass(satisfaction) {
            if (satisfaction >= 80) return 'high';
            if (satisfaction >= 60) return 'medium';
            return 'low';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.dashboard-container').insertBefore(errorDiv, document.querySelector('.stats-grid'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html> 