<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°„í˜¸ì‚¬ ê·¼ë¬´ í¬ë§ì‚¬í•­ ì œì¶œ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .page-status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .page-status-overlay h2 {
            padding: 20px;
            background: #e9ecef;
            border-radius: 10px;
        }
        #result-display {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .result-table {
            flex: 1;
            border-collapse: collapse;
        }
        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .result-table th {
            background-color: #f2f2f2;
        }
        .submit-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
        }
        .submit-container button {
            width: auto;
            padding: 15px 25px;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .content-wrapper {
            display: flex;
        }
        .bookmarks-container {
            width: 200px;
            padding-right: 20px;
        }
        .bookmark {
            padding: 8px 16px;
            margin: 0 4px;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }
        .bookmark:hover {
            background: #bbdefb;
            transform: translateY(-2px);
        }
        .bookmark.active {
            background: #2196f3;
            color: white;
        }
        .bookmark.closed {
            background: #f5f5f5;
            border-color: #9e9e9e;
            color: #757575;
            opacity: 0.7;
        }
        .bookmark.closed:hover {
            background: #eeeeee;
            transform: none;
        }
        .main-content {
            flex: 1;
        }
        
        /* ê·€ì—¬ìš´ ê°„í˜¸ì‚¬ ë¡œë”© í™”ë©´ */
        .cute-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 10px;
        }
        
        .nurse-character {
            width: 200px;
            height: 200px;
            margin-bottom: 20px;
            position: relative;
        }
        
        /* ê³ ì–‘ì´ ëª¸í†µ */
        .cat-body {
            width: 100px;
            height: 120px;
            background: #f8f8f8;
            border-radius: 50px 50px 30px 30px;
            position: absolute;
            left: 50%;
            top: 60px;
            transform: translateX(-50%);
            border: 3px solid #ff6b9d;
            z-index: 1;
        }
        
        /* ê³ ì–‘ì´ ë¨¸ë¦¬ */
        .cat-head {
            width: 90px;
            height: 80px;
            background: #ffeaa7;
            border-radius: 45px;
            position: absolute;
            left: 50%;
            top: 30px;
            transform: translateX(-50%);
            border: 3px solid #ff6b9d;
            z-index: 2;
        }
        
        /* ê³ ì–‘ì´ ê·€ */
        .cat-ear {
            width: 25px;
            height: 30px;
            background: #ffeaa7;
            border-radius: 15px 15px 0 0;
            position: absolute;
            top: 25px;
            border: 2px solid #ff6b9d;
            border-bottom: none;
        }
        
        .cat-ear.left {
            left: 20px;
            transform: rotate(-15deg);
        }
        
        .cat-ear.right {
            right: 20px;
            transform: rotate(15deg);
        }
        
        .cat-ear::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 15px;
            background: #fd79a8;
            border-radius: 8px 8px 0 0;
        }
        
        /* ê°„í˜¸ì‚¬ ëª¨ì */
        .nurse-cap {
            width: 50px;
            height: 20px;
            background: white;
            border-radius: 25px 25px 0 0;
            position: absolute;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            border: 2px solid #ff6b9d;
            border-bottom: none;
            z-index: 3;
        }
        
        .nurse-cap::after {
            content: '+';
            position: absolute;
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
            color: #e84393;
            font-weight: bold;
            font-size: 12px;
        }
        
        /* ê³ ì–‘ì´ ì–¼êµ´ */
        .cat-face {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
        }
        
        .cat-eyes {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            justify-content: center;
        }
        
        .cat-eye {
            width: 12px;
            height: 12px;
            background: #2d3436;
            border-radius: 50%;
            position: relative;
            animation: cat-blink 3s infinite;
        }
        
        .cat-eye::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
        }
        
        .cat-nose {
            width: 8px;
            height: 6px;
            background: #fd79a8;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            margin: 0 auto 5px;
        }
        
        .cat-mouth {
            width: 20px;
            height: 10px;
            border: 2px solid #2d3436;
            border-top: none;
            border-radius: 0 0 15px 15px;
            margin: 0 auto;
        }
        
        .cat-whiskers {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .whisker {
            position: absolute;
            width: 20px;
            height: 1px;
            background: #2d3436;
        }
        
        .whisker.left-1 { left: -25px; top: 0; transform: rotate(-10deg); }
        .whisker.left-2 { left: -25px; top: 5px; transform: rotate(10deg); }
        .whisker.right-1 { right: -25px; top: 0; transform: rotate(10deg); }
        .whisker.right-2 { right: -25px; top: 5px; transform: rotate(-10deg); }
        
        /* ê³ ì–‘ì´ íŒ” */
        .cat-arms {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        
        .cat-arm {
            width: 25px;
            height: 40px;
            background: #ffeaa7;
            border-radius: 15px;
            position: absolute;
            border: 2px solid #ff6b9d;
        }
        
        .cat-arm.left {
            left: -20px;
            transform-origin: center top;
        }
        
        .cat-arm.right {
            right: -20px;
            transform-origin: center top;
        }
        
        /* ê³ ì–‘ì´ ê¼¬ë¦¬ */
        .cat-tail {
            width: 15px;
            height: 60px;
            background: #ffeaa7;
            border-radius: 8px;
            position: absolute;
            right: -25px;
            top: 100px;
            border: 2px solid #ff6b9d;
            transform-origin: center top;
            animation: tail-wag 2s ease-in-out infinite;
        }
        
        /* ì¡°ì‚¬í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        .investigating .cat-arm.left {
            animation: cat-investigate-left 1.5s ease-in-out infinite;
        }
        
        .investigating .cat-arm.right {
            animation: cat-investigate-right 1.5s ease-in-out infinite;
        }
        
        .investigating .magnifying-glass {
            position: absolute;
            top: 95px;
            right: -35px;
            width: 20px;
            height: 20px;
            border: 3px solid #74b9ff;
            border-radius: 50%;
            animation: magnify 1.5s ease-in-out infinite;
            z-index: 4;
        }
        
        .investigating .magnifying-glass::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -8px;
            width: 3px;
            height: 12px;
            background: #74b9ff;
            border-radius: 2px;
            transform: rotate(45deg);
        }
        
        /* ë¬¸ì„œ ì •ë¦¬í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        .organizing .cat-arm.left {
            animation: cat-organize-left 1.2s ease-in-out infinite;
        }
        
        .organizing .cat-arm.right {
            animation: cat-organize-right 1.2s ease-in-out infinite;
        }
        
        .organizing .papers {
            position: absolute;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4;
        }
        
        .paper {
            width: 12px;
            height: 16px;
            background: white;
            border: 1px solid #ddd;
            position: absolute;
            border-radius: 2px;
        }
        
        .paper:nth-child(1) {
            left: -8px;
            animation: paper-shuffle-1 1.2s ease-in-out infinite;
        }
        
        .paper:nth-child(2) {
            left: 0px;
            animation: paper-shuffle-2 1.2s ease-in-out infinite;
        }
        
        .paper:nth-child(3) {
            left: 8px;
            animation: paper-shuffle-3 1.2s ease-in-out infinite;
        }
        
        .loading-message {
            font-size: 24px;
            color: #ff6b9d;
            font-weight: bold;
            margin-bottom: 10px;
            animation: pulse-text 1s ease-in-out infinite;
        }
        
        .loading-subtitle {
            font-size: 16px;
            color: #666;
            animation: fade-in-out 2s ease-in-out infinite;
        }
        
        /* í‚¤í”„ë ˆì„ ì• ë‹ˆë©”ì´ì…˜ë“¤ */
        @keyframes cat-blink {
            0%, 90%, 100% { height: 12px; }
            95% { height: 2px; }
        }
        
        @keyframes tail-wag {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-10deg); }
        }
        
        @keyframes cat-investigate-left {
            0%, 100% { transform: rotate(-20deg); }
            50% { transform: rotate(-35deg); }
        }
        
        @keyframes cat-investigate-right {
            0%, 100% { transform: rotate(45deg); }
            50% { transform: rotate(25deg); }
        }
        
        @keyframes magnify {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        @keyframes cat-organize-left {
            0%, 100% { transform: rotate(-10deg) translateY(0); }
            50% { transform: rotate(-20deg) translateY(-5px); }
        }
        
        @keyframes cat-organize-right {
            0%, 100% { transform: rotate(10deg) translateY(0); }
            50% { transform: rotate(20deg) translateY(-5px); }
        }
        
        @keyframes paper-shuffle-1 {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(-5deg); }
        }
        
        @keyframes paper-shuffle-2 {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-3px) rotate(2deg); }
            75% { transform: translateY(-3px) rotate(-2deg); }
        }
        
        @keyframes paper-shuffle-3 {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-4px) rotate(3deg); }
        }
        
        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes fade-in-out {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        .tab-container {
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .tab-navigation {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            position: relative;
        }
        
        .tab-button:first-child {
            border-right: 1px solid #e0e0e0;
        }
        
        .tab-button.active {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }
        
        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab-content {
            display: flex;
            width: 200%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .tab-pane {
            width: 50%;
            flex-shrink: 0;
            padding: 0 10px;
        }
        
        .tab-content.slide-to-second {
            transform: translateX(-50%);
        }
        
        /* í¬ë§ ê·¼ë¬´ í˜„í™© í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .wish-status-container {
            display: block;
            width: 100%;
            min-height: calc(100vh - 200px);
        }
        
        .wish-table-container {
            width: 100%;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow: hidden;
            min-height: calc(100vh - 250px);
        }
        
        .wish-table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .wish-table-title {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }
        
        .wish-legend {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        
        .wish-table-wrapper {
            height: calc(100vh - 320px);
            overflow: auto;
            padding: 20px;
        }
        
        .wish-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 800px;
        }
        
        .wish-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 35px;
        }
        
        .wish-table th:first-child {
            width: 120px;
            min-width: 120px;
            left: 0;
            z-index: 11;
            text-align: left;
            padding-left: 15px;
        }
        
        .wish-table td {
            border: 1px solid #dee2e6;
            padding: 0;
            text-align: center;
            height: 40px;
            min-width: 35px;
            position: relative;
            background: black;
        }
        
        .wish-table td:first-child {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: 500;
            color: #495057;
            width: 120px;
            min-width: 120px;
            position: sticky;
            left: 0;
            z-index: 10;
            text-align: left;
            white-space: nowrap;
        }
        
        .wish-cell {
            width: 100%;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            position: relative;
            background: black;
        }

        .wish-cell.off-weighted {
            background: repeating-linear-gradient(
                45deg,
                #FF8C00,
                #FF8C00 3px,
                #FFA500 3px,
                #FFA500 6px
            );
        }

        .shift-marker {
            width: 12px;
            height: 12px;
            margin: 1px;
            border-radius: 2px;
            position: relative;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .shift-marker.diagonal {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.2) 2px,
                rgba(255,255,255,0.2) 4px
            );
        }

        /* ì‹œí”„íŠ¸ ì»¬ëŸ¬ ì •ì˜ */
        .shift-D { background-color: #87CEEB; }
        .shift-E { background-color: #DDA0DD; }
        .shift-N { background-color: #4169E1; }
        .shift-OFF { background-color: #90EE90; }
        .shift-custom { background-color: #FFB6C1; }

        /* ë¹ˆ ì…€ì€ ê²€ì€ìƒ‰ ìœ ì§€ */
        .wish-cell:empty {
            background: black;
        }

        .loading-status {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
        .calendar-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .calendar-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .calendar-title {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
            margin: 0 0 15px 0;
        }
        
        .shift-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .shift-selector-label {
            font-weight: 500;
            margin-right: 10px;
            align-self: center;
            color: #495057;
        }
        
        .shift-btn {
            padding: 6px 12px;
            border: 2px solid transparent;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            min-width: 40px;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .shift-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .shift-btn.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .calendar-table th,
        .calendar-table td {
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
            height: 40px;
            min-width: 40px;
        }
        
        .calendar-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
        }
        
        .calendar-table td {
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .calendar-table td:hover {
            background: #e9ecef;
        }
        
        .calendar-table td.other-month {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .calendar-table td.other-month:hover {
            background: transparent;
        }
        
        .calendar-date {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }
        
        .calendar-shift-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            font-size: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .calendar-submit-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .calendar-submit-btn:hover {
            background: #218838;
        }
        
        .calendar-submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-shifts {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .modal-shift-btn {
            padding: 8px 16px;
            border: 2px solid transparent;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .modal-shift-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .modal-shift-btn.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        
        .reason-section {
            margin-top: 20px;
        }
        
        .reason-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .reason-option input[type="radio"] {
            margin-right: 8px;
        }
        
        .reason-option label {
            font-weight: 500;
            color: #495057;
            cursor: pointer;
        }
        
        .reason-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-top: 8px;
            resize: vertical;
            min-height: 60px;
        }
        
        .reason-input:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn.cancel:hover {
            background: #545b62;
        }
        
        .modal-btn.confirm {
            background: #007bff;
            color: white;
        }
        
        .modal-btn.confirm:hover {
            background: #0056b3;
        }
        
        .modal-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        /* ì£¼ë§Â·ê³µíœ´ì¼ ê°•ì¡° */
        .weekend-cell,          /* ë°ì´í„° ì…€ */
        .weekend-header {       /* í—¤ë” ì…€(ë‚ ì§œ ë²ˆí˜¸) */
        box-shadow: inset 0 0 0 2px #ff4d4d;   /* ë¹¨ê°„ ì•ˆìª½ í…Œë‘ë¦¬ */
        }
        /* holiday-cell ì •ì˜ë¥¼ ì´ê²ƒìœ¼ë¡œ êµì²´ */
        .wish-table td.holiday-cell{
        border: 2px solid #e74c3c;        /* ë¹¨ê°„ êµµì€ í…Œë‘ë¦¬ */
        box-sizing: border-box;           /* ë‚´ìš©ì´ ëˆŒë¦¬ì§€ ì•Šê²Œ */
        }

</style>

    <script src="/static/js/prefs_utils.js"></script>
</head>
<body>
    <div id="mySidebar" class="sidebar">
        <button class="sidebar-toggle-btn" onclick="toggleNav()"><i class="fa-solid fa-angles-left"></i></button>
        <a href="/" class="active">Wanted ì‘ì„±</a>
        <a href="/roster-view">ê·¼ë¬´í‘œ ë³´ê¸°</a>
        {% if user.is_head_nurse %}
        <a href="/head-nurse-management">ë¶€ì„œì› ê´€ë¦¬</a>
        <a href="/roster-create">ê·¼ë¬´í‘œ ìƒì„±</a>
        <a href="/roster-configure">ê·¼ë¬´í‘œ ì„¤ì •</a>
        {% endif %}
        <a href="javascript:void(0);" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <div id="main">
        <div class="container" style="position: relative;">
            <div id="page-status" class="page-status-overlay" style="display: none;">
                <h2 id="status-message"></h2>
            </div>

            <h1>ê°„í˜¸ì‚¬ ê·¼ë¬´ í¬ë§ì‚¬í•­</h1>

            <div class="content-wrapper">
                <div id="bookmarks-container" class="bookmarks-container">
                    <!-- Bookmarks will be inserted here -->
                </div>
                <div class="main-content">
                    <div class="tab-container">
                        <div class="tab-navigation">
                            <button class="tab-button active" onclick="switchTab(0)">ë‚´ í¬ë§ì‚¬í•­ ì‘ì„±</button>
                            <button class="tab-button" onclick="switchTab(1)">ì „ì²´ í¬ë§ì‚¬í•­ í˜„í™©</button>
                        </div>
                        
                        <div class="tab-content" id="tab-content">
                            <!-- ì²« ë²ˆì§¸ íƒ­: ê¸°ì¡´ í¬ë§ì‚¬í•­ ì‘ì„± -->
                            <div class="tab-pane">
                                <div id="nurse-view">
                                    <div class="form-group">
                                        <label for="wanted-input">í¬ë§ ê·¼ë¬´ ë‚´ìš© (Wanted)</label>
                                        <textarea id="wanted-input" placeholder="ì˜ˆ: ì£¼ë§ ì¶œê·¼ì€ ìµœëŒ€í•œ Nìœ¼ë¡œ í•˜ê³ ì‹¶ì–´ìš”."></textarea>
                                    </div>
                                    <button onclick="submitRequest()">ê·¼ë¬´ í¬ë§ ì´ˆì•ˆ ì €ì¥ ë° ë¶„ì„</button>
                                </div>
                    
                                <!-- ê·€ì—¬ìš´ ê°„í˜¸ì‚¬ ë¡œë”© í™”ë©´ -->
                                <div class="cute-loader" id="cute-loader" style="display: none;">
                                    <div class="nurse-character" id="nurse-character">
                                        <div class="cat-body"></div>
                                        <div class="cat-head">
                                            <div class="cat-ear left"></div>
                                            <div class="cat-ear right"></div>
                                        </div>
                                        <div class="nurse-cap"></div>
                                        <div class="cat-face">
                                            <div class="cat-eyes">
                                                <div class="cat-eye"></div>
                                                <div class="cat-eye"></div>
                                            </div>
                                            <div class="cat-nose"></div>
                                            <div class="cat-mouth"></div>
                                        </div>
                                        <div class="cat-whiskers">
                                            <div class="whisker left-1"></div>
                                            <div class="whisker left-2"></div>
                                            <div class="whisker right-1"></div>
                                            <div class="whisker right-2"></div>
                                        </div>
                                        <div class="cat-arms">
                                            <div class="cat-arm left"></div>
                                            <div class="cat-arm right"></div>
                                        </div>
                                        <div class="cat-tail"></div>
                                    </div>
                                    <div class="loading-message" id="loading-message">ìš”ì²­ ë¶„ì„ì¤‘...</div>
                                    <div class="loading-subtitle" id="loading-subtitle">ì—´ì‹¬íˆ ë¶„ì„í•˜ê³  ìˆì–´ìš”! ğŸ”</div>
                                </div>
                    
                                <div id="result-container" style="display: none; position: relative;">
                                    <h2>ì²˜ë¦¬ ê²°ê³¼</h2>
                                    <div id="result-display"></div>
                                </div>
                            </div>
                            
                            <!-- ë‘ ë²ˆì§¸ íƒ­: ì „ì²´ í¬ë§ì‚¬í•­ í˜„í™© -->
                            <div class="tab-pane">
                                <div class="wish-status-container">
                                    <div class="wish-table-container">
                                        <div class="wish-table-header">
                                            <h3 class="wish-table-title" id="wish-table-title">ì „ì²´ í¬ë§ì‚¬í•­ í˜„í™©</h3>
                                            <div class="wish-legend">
                                                <div class="legend-item">
                                                    <div class="legend-color shift-D"></div>
                                                    <span>Day</span>
                                                </div>
                                                <div class="legend-item">
                                                    <div class="legend-color shift-E"></div>
                                                    <span>Evening</span>
                                                </div>
                                                <div class="legend-item">
                                                    <div class="legend-color shift-N"></div>
                                                    <span>Night</span>
                                                </div>
                                                <div class="legend-item">
                                                    <div class="legend-color shift-OFF"></div>
                                                    <span>OFF</span>
                                                </div>
                                                <div class="legend-item">
                                                    <div class="legend-color off-weighted"></div>
                                                    <span>OFF ê°€ì¤‘</span>
                                                </div>
                                                <div class="legend-item">
                                                    <div class="legend-color shift-custom"></div>
                                                    <span>ê¸°íƒ€</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="wish-table-wrapper">
                                            <div id="wish-table-content">
                                                <div class="loading-status">
                                                    ì›”ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì›”ì˜ ì „ì²´ í¬ë§ì‚¬í•­ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="submit-section" class="submit-container" style="display: none;">
                 <button id="final-submit-btn" onclick="finalSubmit()">ìµœì¢… ì œì¶œ</button>
            </div>
            
            <!-- ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ -->
            <div id="calendar-container" class="calendar-container">
                <div class="calendar-header">
                    <h3 id="calendar-title" class="calendar-title">í¬ë§ ê·¼ë¬´ ìº˜ë¦°ë”</h3>
                    
                    <!-- ê·¼ë¬´ ì½”ë“œ ì„ íƒê¸° -->
                    <div class="shift-selector">
                        <span class="shift-selector-label">ê·¼ë¬´ ì½”ë“œ:</span>
                        <div id="shift-buttons-container">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                        </div>
                    </div>
                </div>
                
                <!-- ìº˜ë¦°ë” í…Œì´ë¸” -->
                <table class="calendar-table">
                    <thead>
                        <tr>
                            <th>ì¼</th>
                            <th>ì›”</th>
                            <th>í™”</th>
                            <th>ìˆ˜</th>
                            <th>ëª©</th>
                            <th>ê¸ˆ</th>
                            <th>í† </th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </tbody>
                </table>
                
                <!-- í¬ë§ ë‚´ìš© ë°˜ì˜í•˜ê¸° ë²„íŠ¼ -->
                <button id="calendar-submit-btn" class="calendar-submit-btn" onclick="submitCalendarData()">
                    í¬ë§ ë‚´ìš© ë°˜ì˜í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">ë‚ ì§œ ì„ íƒ</h3>
            </div>
            <div class="modal-body">
                <!-- ê·¼ë¬´ ì½”ë“œ ì„ íƒ -->
                <div class="modal-shifts" id="modal-shifts">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                
                <!-- ì‚¬ìœ  ì„ íƒ -->
                <div class="reason-section">
                    <div class="reason-option">
                        <input type="radio" id="reason-direct" name="reason-type" value="direct" checked>
                        <label for="reason-direct">ì‚¬ìœ  ì§ì ‘ ì…ë ¥í•˜ê¸°</label>
                    </div>
                    <textarea id="reason-input" class="reason-input" placeholder="í¬ë§ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button id="modal-confirm-btn" class="modal-btn confirm" onclick="confirmModal()">ì…ë ¥</button>
            </div>
        </div>
    </div>
    <script>
        let fullNurseSchema = [];
        let wantedList = [];
        let activeYear, activeMonth;
        
        // ìº˜ë¦°ë” ê´€ë ¨ ë³€ìˆ˜ë“¤
        let availableShifts = [];
        let selectedShift = null;
        let calendarData = {}; // {date: {shift: 'D', reason: 'text'}}
        let modalSelectedDate = null;
        let modalSelectedShift = null;

        /* âœ… ìƒˆ ì „ì—­ ë³€ìˆ˜ */
        let holidayDates = [];          // ISO ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ ["2025-06-06", â€¦]

        /* âœ… íœ´ì¼/ì£¼ë§ ë‚ ì§œë¥¼ ì„œë²„ì—ì„œ ë°›ì•„ì˜¤ëŠ” í•¨ìˆ˜  */
        async function loadHolidayDates(year, month) {
                try {
                    const res = await fetch(`/dates/holidays?year=${year}&month=${month}`);
                    if (!res.ok) throw new Error('íœ´ì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    /* ë¦¬ìŠ¤íŠ¸ â†’ Set  (ì „ì—­) */
                    holidayDates = new Set(await res.json());       // â¬…ï¸ ì´ í•œ ì¤„
                    console.log('ğŸŸ¥ holidayDates =', holidayDates);
                } catch (err) {
                    console.error(err);
                    holidayDates = new Set();                       // ì‹¤íŒ¨ ì‹œ ë¹„ì›Œ ë‘ê¸°
                }
                }



        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘');
            
            // Setup sidebar and basic listeners
            document.getElementById("mySidebar").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
            document.getElementById('wanted-input').addEventListener('keydown', handleKeydown);
            
            try {
                console.log('ê°„í˜¸ì‚¬ ìŠ¤í‚¤ë§ˆ ë¡œë“œ ì‹œì‘');
                await fetchNurseSchema();
                console.log('ê°„í˜¸ì‚¬ ìŠ¤í‚¤ë§ˆ ë¡œë“œ ì™„ë£Œ');
                
                // console.log('shifts ë°ì´í„° ë¡œë“œ ì‹œì‘');
                // await loadShifts();
                // console.log('shifts ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                
                console.log('ë¶ë§ˆí¬ ì´ˆê¸°í™” ì‹œì‘');
                await initializeBookmarks();
                console.log('ë¶ë§ˆí¬ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                const statusMessage = document.getElementById('status-message');
                const pageStatusDiv = document.getElementById('page-status');
                statusMessage.textContent = 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                pageStatusDiv.style.display = 'flex';
            }
        });

        function handleKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                submitRequest();
            }
        }

        async function initializeBookmarks() {
            const pageStatusDiv = document.getElementById('page-status');
            const statusMessage = document.getElementById('status-message');
            const bookmarksContainer = document.getElementById('bookmarks-container');
            
            try {
                console.log('wanted ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                
                // ëª¨ë“  wanted ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
                const wantedResponse = await fetch('/wanted/all');
                console.log('Wanted API ì‘ë‹µ ìƒíƒœ:', wantedResponse.status, wantedResponse.statusText);
                
                if (!wantedResponse.ok) {
                    const errorText = await wantedResponse.text();
                    console.error('Wanted API ì—ëŸ¬ ì‘ë‹µ:', errorText);
                    throw new Error('Wanted ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + wantedResponse.status);
                }
                
                wantedList = await wantedResponse.json();
                console.log('ë¶ˆëŸ¬ì˜¨ wanted ëª©ë¡:', wantedList);

                if (wantedList.length === 0) {
                    console.log('wanted ëª©ë¡ì´ ë¹„ì–´ìˆìŒ');
                    statusMessage.textContent = 'wanted ì‘ì„± ìš”ì²­ ì „ì…ë‹ˆë‹¤. ìˆ˜ê°„í˜¸ì‚¬ì—ê²Œ ìš”ì²­í•´ì£¼ì„¸ìš”.';
                    pageStatusDiv.style.display = 'flex';
                    bookmarksContainer.innerHTML = '';
                    return;
                }

                console.log('ë¶ë§ˆí¬ ë Œë”ë§ ì‹œì‘');
                // ë¶ë§ˆí¬ ë Œë”ë§
                pageStatusDiv.style.display = 'none';
                renderBookmarks();
                
                // ì²« ë²ˆì§¸ wanted ìë™ ì„ íƒ
                if (wantedList.length > 0) {
                    console.log('ì²« ë²ˆì§¸ ìŠ¤ì¼€ì¤„ ì„ íƒ:', wantedList[0]);
                    await switchActiveSchedule(wantedList[0].year, wantedList[0].month);
                }
            } catch (error) {
                console.error('initializeBookmarks ì˜¤ë¥˜:', error);
                statusMessage.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                pageStatusDiv.style.display = 'flex';
            }
        }

        function renderBookmarks() {
            const bookmarksContainer = document.getElementById('bookmarks-container');
            bookmarksContainer.innerHTML = '';
            
            wantedList.forEach(wanted => {
                const bookmark = document.createElement('div');
                bookmark.className = 'bookmark';
                bookmark.textContent = `${wanted.year}ë…„ ${wanted.month}ì›”`;
                bookmark.dataset.year = wanted.year;
                bookmark.dataset.month = wanted.month;
                
                // wanted ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ë§
                if (wanted.status === 'closed') {
                    bookmark.classList.add('closed');
                    bookmark.title = 'wanted ì‘ì„±ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.';
                }
                
                bookmark.onclick = () => switchActiveSchedule(wanted.year, wanted.month);
                bookmarksContainer.appendChild(bookmark);
            });
        }

        async function switchActiveSchedule(year, month) {
            activeYear = year;
            activeMonth = month;
            
            // Update active class on bookmarks
            document.querySelectorAll('.bookmark').forEach(bm => {
                if (bm.dataset.year == year && bm.dataset.month == month) {
                    bm.classList.add('active');
                } else {
                    bm.classList.remove('active');
                }
            });

            await checkWantedStatus();
            
            // í˜„ì¬ ë‘ ë²ˆì§¸ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í¬ë§ì‚¬í•­ í˜„í™©ë„ ì—…ë°ì´íŠ¸
            const secondTabButton = document.querySelectorAll('.tab-button')[1];
            if (secondTabButton && secondTabButton.classList.contains('active')) {
                loadWishStatus();
            }
            
            // ìº˜ë¦°ë” ì—…ë°ì´íŠ¸
            await updateCalendar();
        }

        async function checkWantedStatus() {
            const statusMessage = document.getElementById('status-message');
            const pageStatusDiv = document.getElementById('page-status');
            
            if (!activeYear || !activeMonth) {
                statusMessage.textContent = 'ë…„ë„ì™€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                pageStatusDiv.style.display = 'flex';
                return;
            }

            try {
                // ì „ì—­ wantedList ì‚¬ìš© (initializeBookmarksì—ì„œ ì´ë¯¸ ë¡œë“œë¨)
                const currentWanted = wantedList.find(w => w.year === activeYear && w.month === activeMonth);
                
                if (!currentWanted) {
                    statusMessage.textContent = 'wanted ì‘ì„± ìš”ì²­ ì „ì…ë‹ˆë‹¤. ìˆ˜ê°„í˜¸ì‚¬ì—ê²Œ ìš”ì²­í•´ì£¼ì„¸ìš”.';
                    pageStatusDiv.style.display = 'flex';
                    return;
                }

                if (currentWanted.status === 'closed') {
                    // wantedê°€ ë§ˆê°ëœ ê²½ìš°: í¼ì€ ë¹„í™œì„±í™”í•˜ë˜, ë‹¤ë¥¸ ë¶ë§ˆí¬ëŠ” í™œì„±í™” ìœ ì§€
                    setClosedState();
                    return;
                }

                // wanted ìƒíƒœê°€ 'requested'ì¸ ê²½ìš° ìµœì‹  preference ìƒíƒœ í™•ì¸
                pageStatusDiv.style.display = 'none';
                
                // ìµœì‹  ì„ í˜¸ë„ ë°ì´í„° ì¡°íšŒ
                const response = await fetch(`/preferences/latest?year=${activeYear}&month=${activeMonth}`);
                if (!response.ok) throw new Error('ì„ í˜¸ë„ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                const statusData = await response.json();

                const isSubmitted = statusData.is_submitted;

                if (isSubmitted) {
                    setSubmittedState(statusData.preference_data, statusData.created_at, statusData.submitted_at);
                } else {
                    setDraftState(statusData.preference_data, statusData.created_at);
                }
            } catch (error) {
                console.error(error);
                statusMessage.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                pageStatusDiv.style.display = 'flex';
            }
        }

        function setSubmittedState(preferenceData, createdAt, submittedAt) {
            // closed-notice ìˆ¨ê¸°ê¸°
            const closedNotice = document.getElementById('closed-notice');
            if (closedNotice) {
                closedNotice.style.display = 'none';
            }
            
            // ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”
            document.getElementById('wanted-input').disabled = true;
            document.getElementById('wanted-input').placeholder = 'ì œì¶œëœ í¬ë§ ê·¼ë¬´ ë‚´ìš© (ìˆ˜ì •í•˜ë ¤ë©´ ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”)';
            
            // í¬ë§ì‚¬í•­ í™•ì¸ ë²„íŠ¼ ë¹„í™œì„±í™”
            const confirmBtn = document.querySelector('#nurse-view button');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'ì œì¶œ ì™„ë£Œ';
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            document.getElementById('result-container').style.display = 'block';
            
            // ìµœì¢… ì œì¶œ ë²„íŠ¼ì„ ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            const submitBtn = document.getElementById('final-submit-btn');
            submitBtn.textContent = 'ìˆ˜ì •í•˜ê¸°';
            submitBtn.onclick = retractSubmission;
            document.getElementById('submit-section').style.display = 'block';
            
            // ì œì¶œ ì •ë³´ í‘œì‹œ
            const submitSection = document.getElementById('submit-section');
            let submitInfo = document.getElementById('submit-info');
            if (!submitInfo) {
                submitInfo = document.createElement('div');
                submitInfo.id = 'submit-info';
                submitInfo.style.cssText = `
                    background: #d4edda;
                    border: 1px solid #c3e6cb;
                    color: #155724;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                    font-size: 14px;
                `;
                submitSection.insertBefore(submitInfo, submitBtn);
            }
            submitInfo.textContent = `ì œì¶œ ì™„ë£Œ (${new Date(submittedAt).toLocaleString('ko-KR')})`;
            submitInfo.style.display = 'block';
            
            // ë°ì´í„° í‘œì‹œ
            if (preferenceData) {
                document.getElementById('wanted-input').value = preferenceData.request || '';
                displayResults(preferenceData);
            } else {
                displayResults(null);
            }
        }

        function setDraftState(preferenceData, createdAt) {
            // closed-notice ìˆ¨ê¸°ê¸°
            const closedNotice = document.getElementById('closed-notice');
            if (closedNotice) {
                closedNotice.style.display = 'none';
            }
            
            // ì œì¶œ ì •ë³´ ìˆ¨ê¸°ê¸°
            const submitInfo = document.getElementById('submit-info');
            if (submitInfo) {
                submitInfo.style.display = 'none';
            }
            
            // ì…ë ¥ í•„ë“œ í™œì„±í™”
            document.getElementById('wanted-input').disabled = false;
            document.getElementById('wanted-input').placeholder = 'í¬ë§ ê·¼ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”';
            
            // í¬ë§ì‚¬í•­ í™•ì¸ ë²„íŠ¼ í™œì„±í™”
            const confirmBtn = document.querySelector('#nurse-view button');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'í¬ë§ì‚¬í•­ í™•ì¸';

            // ìµœì¢… ì œì¶œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            const submitBtn = document.getElementById('final-submit-btn');
            submitBtn.textContent = 'ìµœì¢… ì œì¶œ';
            submitBtn.onclick = finalSubmit;
            document.getElementById('submit-section').style.display = 'block';

            // ë°ì´í„° í‘œì‹œ
            if (preferenceData) {
                document.getElementById('wanted-input').value = preferenceData.request || '';
                displayResults(preferenceData);
                document.getElementById('result-container').style.display = 'block';
                
                // Draft ì •ë³´ í‘œì‹œ
                if (createdAt) {
                    const submitSection = document.getElementById('submit-section');
                    let draftInfo = document.getElementById('draft-info');
                    if (!draftInfo) {
                        draftInfo = document.createElement('div');
                        draftInfo.id = 'draft-info';
                        draftInfo.style.cssText = `
                            background: #fff3cd;
                            border: 1px solid #ffeaa7;
                            color: #856404;
                            padding: 10px;
                            border-radius: 5px;
                            margin-bottom: 10px;
                            font-size: 14px;
                        `;
                        submitSection.insertBefore(draftInfo, submitBtn);
                    }
                    draftInfo.textContent = `ì„ì‹œ ì €ì¥ë¨ (${new Date(createdAt).toLocaleString('ko-KR')})`;
                    draftInfo.style.display = 'block';
                }
            } else {
                document.getElementById('wanted-input').value = '';
                document.getElementById('result-container').style.display = 'none';
                
                // Draft ì •ë³´ ìˆ¨ê¸°ê¸°
                const draftInfo = document.getElementById('draft-info');
                if (draftInfo) {
                    draftInfo.style.display = 'none';
                }
            }
        }

        function setClosedState() {
            // í˜ì´ì§€ ì˜¤ë²„ë ˆì´ëŠ” ìˆ¨ê¸°ê³ , í¼ë§Œ ë¹„í™œì„±í™”
            const pageStatusDiv = document.getElementById('page-status');
            pageStatusDiv.style.display = 'none';
            
            // í¼ ì˜ì—­ ë¹„í™œì„±í™”
            document.getElementById('wanted-input').disabled = true;
            document.getElementById('wanted-input').value = '';
            document.getElementById('wanted-input').placeholder = `${activeYear}ë…„ ${activeMonth}ì›” wanted ì‘ì„±ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            const button = document.querySelector('#nurse-view button');
            if (button) {
                button.disabled = true;
                button.textContent = 'ë§ˆê°ë¨';
            }
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆì™€ ì œì¶œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('submit-section').style.display = 'none';
            
            // ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ (ì˜¤ë²„ë ˆì´ ì—†ì´)
            const mainContent = document.querySelector('.main-content');
            let closedNotice = document.getElementById('closed-notice');
            if (!closedNotice) {
                closedNotice = document.createElement('div');
                closedNotice.id = 'closed-notice';
                closedNotice.style.cssText = `
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 20px 0;
                    text-align: center;
                    font-weight: 500;
                `;
                mainContent.insertBefore(closedNotice, mainContent.firstChild);
            }
            closedNotice.textContent = `${activeYear}ë…„ ${activeMonth}ì›” wanted ì‘ì„±ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`;
            closedNotice.style.display = 'block';
        }

        async function fetchNurseSchema() {
             try {
                console.log('ê°„í˜¸ì‚¬ ìŠ¤í‚¤ë§ˆ API í˜¸ì¶œ ì¤‘...');
                const response = await fetch('/nurses');
                console.log('ê°„í˜¸ì‚¬ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                 if (!response.ok) {
                    if (response.status === 401) {
                        console.log('ì¸ì¦ ì‹¤íŒ¨, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('ê°„í˜¸ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                fullNurseSchema = await response.json();
                console.log('ë¶ˆëŸ¬ì˜¨ ê°„í˜¸ì‚¬ ìŠ¤í‚¤ë§ˆ:', fullNurseSchema);
            } catch(error) {
                console.error('fetchNurseSchema ì˜¤ë¥˜:', error);
                throw error;  // ìƒìœ„ë¡œ ì˜¤ë¥˜ ì „íŒŒ
            }
        }

        async function submitRequest() {
            const wantedInput = document.getElementById('wanted-input').value;
            const loader = document.getElementById('cute-loader');
            const resultContainer = document.getElementById('result-container');
            const nurseCharacter = document.getElementById('nurse-character');
            const loadingMessage = document.getElementById('loading-message');
            const loadingSubtitle = document.getElementById('loading-subtitle');
            
            if (!wantedInput) {
                alert('í¬ë§ ê·¼ë¬´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const payload = { request: wantedInput, schema: fullNurseSchema, case: null };
            
            // result-containerë¥¼ ë¨¼ì € í‘œì‹œí•˜ê³  ê·¸ ì•ˆì— ë¡œë”© í‘œì‹œ
            resultContainer.style.display = 'block';
            loader.style.display = 'flex';
            
            // 1ë‹¨ê³„: ìš”ì²­ ë¶„ì„ì¤‘... (ì¡°ì‚¬í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜)
            nurseCharacter.className = 'nurse-character investigating';
            loadingMessage.textContent = 'ìš”ì²­ ë¶„ì„ì¤‘...';
            loadingSubtitle.textContent = 'ê³ ì–‘ì´ ê°„í˜¸ì‚¬ê°€ ê¼¼ê¼¼íˆ ë¶„ì„í•˜ê³  ìˆì–´ìš”! ğŸ”';
            
            // ë‹ë³´ê¸° ì¶”ê°€
            const magnifyingGlass = document.createElement('div');
            magnifyingGlass.className = 'magnifying-glass';
            nurseCharacter.appendChild(magnifyingGlass);

            try {
                // 3ì´ˆ í›„ 2ë‹¨ê³„ë¡œ ì „í™˜
                setTimeout(() => {
                    // ë‹ë³´ê¸° ì œê±°
                    const oldMagnifyingGlass = nurseCharacter.querySelector('.magnifying-glass');
                    if (oldMagnifyingGlass) {
                        oldMagnifyingGlass.remove();
                    }
                    
                    // 2ë‹¨ê³„: ìš”ì²­ ì •ë¦¬ì¤‘... (ë¬¸ì„œ ì •ë¦¬í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜)
                    nurseCharacter.className = 'nurse-character organizing';
                    loadingMessage.textContent = 'ìš”ì²­ ì •ë¦¬ì¤‘...';
                    loadingSubtitle.textContent = 'ê³ ì–‘ì´ ê°„í˜¸ì‚¬ê°€ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•˜ê³  ìˆì–´ìš”! ğŸ“‹';
                    
                    // ì„œë¥˜ ì¶”ê°€
                    const papers = document.createElement('div');
                    papers.className = 'papers';
                    papers.innerHTML = '<div class="paper"></div><div class="paper"></div><div class="paper"></div>';
                    nurseCharacter.appendChild(papers);
                }, 3000);

                const response = await fetch('/wanted/invoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                console.log('activeYear:', activeYear, 'activeMonth:', activeMonth);
                console.log('API ì‘ë‹µ ë°ì´í„°:', data);

                if (!activeYear || !activeMonth) {
                    throw new Error('ë…„ë„ì™€ ì›” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ì¼€ì¤„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }

                const preferencePayload = {
                    year: activeYear,
                    month: activeMonth,
                    data: { ...data.response, request: wantedInput } // Save the original text request as well
                };

                console.log('ì „ì†¡í•  ë°ì´í„°:', JSON.stringify(preferencePayload, null, 2));

                const saveResponse = await fetch('/preferences', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(preferencePayload)
                });

                if (!saveResponse.ok) {
                    const errorData = await saveResponse.json();
                    console.error('ì €ì¥ ì—ëŸ¬:', errorData);
                    throw new Error(`ì €ì¥ ì‹¤íŒ¨: ${errorData.detail || saveResponse.statusText}`);
                }

                // ë¡œë”© ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
                loader.style.display = 'none';
                displayResults(preferencePayload.data);

            } catch (error) {
                console.error('Error:', error);
                loader.style.display = 'none';
                document.getElementById('result-display').textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
            } finally {
                // ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
                setTimeout(() => {
                    // ëª¨ë“  ì¶”ê°€ ìš”ì†Œ ì œê±°
                    const magnifyingGlass = nurseCharacter.querySelector('.magnifying-glass');
                    const papers = nurseCharacter.querySelector('.papers');
                    if (magnifyingGlass) magnifyingGlass.remove();
                    if (papers) papers.remove();
                    
                    // í´ë˜ìŠ¤ ì´ˆê¸°í™”
                    nurseCharacter.className = 'nurse-character';
                }, 500);
            }
        }

        function displayResults(data) {
            const resultDisplay = document.getElementById('result-display');
            resultDisplay.innerHTML = '';

            if (!data) {
                resultDisplay.innerHTML = 'í‘œì‹œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }
            
            let shiftHtml = '<div><h3>í¬ë§ ê·¼ë¬´</h3><table class="result-table"><tr><th>Shift</th><th>ë‚ ì§œ</th></tr>';
            if (data.shift && Object.keys(data.shift).length > 0) {
                for (const [shift, dates] of Object.entries(data.shift)) {
                    // Dates can be an object or an array from different versions
                    const dateKeys = Array.isArray(dates) ? dates : Object.keys(dates);
                    for (const date of dateKeys) {
                         shiftHtml += `<tr><td>${shift}</td><td>${date}</td></tr>`;
                    }
                }
            } else {
                shiftHtml += '<tr><td colspan="2">ì—†ìŒ</td></tr>';
            }
            shiftHtml += '</table></div>';

            let prefHtml = '<div><h3>ë™ë£Œ ì„ í˜¸</h3><table class="result-table"><tr><th>ê°„í˜¸ì‚¬</th><th>ì„ í˜¸ë„</th></tr>';
            if (data.preference && data.preference.length > 0) {
                 data.preference.forEach(p => {
                    // ìŠ¤í‚¤ë§ˆì— ì¡´ì¬í•˜ëŠ” ê°„í˜¸ì‚¬ì¸ì§€ í™•ì¸
                    const nurse = fullNurseSchema.find(n => n.nurse_id === p.id);
                    if (nurse && p.id) { // ìœ íš¨í•œ ê°„í˜¸ì‚¬ì´ê³  IDê°€ ì¡´ì¬í•  ë•Œë§Œ í‘œì‹œ
                        const preference = p.weight > 0 ? 'ì„ í˜¸' : 'ë¹„ì„ í˜¸';
                        prefHtml += `<tr><td>${nurse.name}</td><td>${preference}</td></tr>`;
                    }
                });
                
                // ìœ íš¨í•œ ì„ í˜¸ ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ "ì—†ìŒ" í‘œì‹œ
                const validPreferences = data.preference.filter(p => {
                    const nurse = fullNurseSchema.find(n => n.nurse_id === p.id);
                    return nurse && p.id;
                });
                
                if (validPreferences.length === 0) {
                    prefHtml += '<tr><td colspan="2">ì—†ìŒ</td></tr>';
                }
            } else {
                prefHtml += '<tr><td colspan="2">ì—†ìŒ</td></tr>';
            }
            prefHtml += '</table></div>';

            resultDisplay.innerHTML = shiftHtml + prefHtml;
        }

        async function finalSubmit() {
            if (!confirm('ìµœì¢… ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            // í˜„ì¬ ìµœì‹  ë°ì´í„° í™•ì¸
            const latestResponse = await fetch(`/preferences/latest?year=${activeYear}&month=${activeMonth}`);
            const latestData = await latestResponse.json();

            let endpoint = '/preferences/submit';
            let body = JSON.stringify({ year: activeYear, month: activeMonth });

            if (!latestData.preference_data) {
                endpoint = '/preferences/submit/empty';
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                alert('ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // ë¦¬ë‹¤ì´ë ‰íŠ¸ ëŒ€ì‹  í˜„ì¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ë°ì´í„° ìœ ì§€
                await checkWantedStatus();
                
            } catch (error) {
                alert('ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function retractSubmission() {
            if (!confirm('ì œì¶œì„ ì² íšŒí•˜ê³  ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch('/preferences/retract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: activeYear, month: activeMonth })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ì² íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                alert('ì œì¶œì´ ì² íšŒë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                
                // í˜„ì¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
                await checkWantedStatus();
                
            } catch (error) {
                alert('ì² íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        // íƒ­ ì „í™˜ ê¸°ëŠ¥
        function switchTab(tabIndex) {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContent = document.getElementById('tab-content');
            
            // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            tabButtons.forEach((button, index) => {
                if (index === tabIndex) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // íƒ­ ë‚´ìš© ìŠ¬ë¼ì´ë”©
            if (tabIndex === 0) {
                tabContent.classList.remove('slide-to-second');
            } else {
                tabContent.classList.add('slide-to-second');
                // ë‘ ë²ˆì§¸ íƒ­ì´ í™œì„±í™”ë  ë•Œ í¬ë§ì‚¬í•­ í˜„í™© ë¡œë“œ
                if (activeYear && activeMonth) {
                    loadWishStatus();
                }
            }
        }

        // í¬ë§ì‚¬í•­ í˜„í™© ë¡œë“œ
        async function loadWishStatus() {
            if (!activeYear || !activeMonth) {
                document.getElementById('wish-table-content').innerHTML = 
                    '<div class="loading-status">ì›”ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì›”ì˜ ì „ì²´ í¬ë§ì‚¬í•­ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
                return;
            }

            try {
                // ì œëª© ì—…ë°ì´íŠ¸
                document.getElementById('wish-table-title').textContent = 
                    `${activeYear}ë…„ ${activeMonth}ì›” ì „ì²´ í¬ë§ì‚¬í•­ í˜„í™©`;

                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                document.getElementById('wish-table-content').innerHTML = 
                    '<div class="loading-status">í¬ë§ì‚¬í•­ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

                // í¬ë§ì‚¬í•­ ë°ì´í„° ë¡œë“œ
                const wishResponse = await fetch(`/preferences/all?year=${activeYear}&month=${activeMonth}`);
                if (!wishResponse.ok) {
                    throw new Error('í¬ë§ì‚¬í•­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                const wishData = await wishResponse.json();
                /* âœ… (2) íœ´ì¼ ë°ì´í„° */
                await loadHolidayDates(activeYear, activeMonth);
                // í…Œì´ë¸” ìƒì„±
                renderWishTable(wishData);

            } catch (error) {
                console.error('í¬ë§ì‚¬í•­ í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('wish-table-content').innerHTML = 
                    `<div class="loading-status" style="color: #dc3545;">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }
/* ê³µíœ´ì¼ Set â†©ï¸  ex) '2025-10-03' */
function getKoreanHolidays(year) {
  const hd = new Holidays('KR');           // ISO-3166 KR
  //   â‘   ì–‘Â·ìŒë ¥ ëª¨ë‘ í¬í•¨
  //   â‘¡  'substitutes': ëŒ€ì²´íœ´ì¼ í¬í•¨ ì—¬ë¶€ â†’ default = true
  const list = hd.getHolidays(year);

  // hd.getHolidays(year) ëŠ”
  //   [{date:'2025-01-01', type:'public', name:'ì‹ ì •', ...}, ...]
  return new Set(list.map(o => o.date));   // Set<YYYY-MM-DD>
}

// /* ì£¼ë§ ë˜ëŠ” ê³µíœ´ì¼ ì—¬ë¶€ */
// function isWeekendOrHoliday(dateObj, holidaySet) {
//   if ([0,6].includes(dateObj.getDay())) return true;             // í† Â·ì¼
//   return holidaySet.has(dateObj.toISOString().slice(0,10));      // ê³µíœ´ì¼
// }


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ renderWishTable  â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderWishTable() {
  const container = document.getElementById('wish-table-content');

  /* 0) ì´ë²ˆ ë‹¬ ì „ì²´ wishDataë¥¼ í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸° */
  const res = await fetch(`/preferences/all?year=${activeYear}&month=${activeMonth}`);
  if (!res.ok) {
    container.innerHTML = '<div class="loading-status">í¬ë§ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  const wishDataArr = await res.json();               // [{nurse_id, preference_data:{shift:{...}}}, â€¦]
  
  /* 1) nurse_id â†’ OFF-ë‚ ì§œ[] ë§µ ë§Œë“¤ê¸° (ê³µí†µ ìœ í‹¸ ì¬ì‚¬ìš©) */
  const offMap = (window.PrefsUtils && window.PrefsUtils.buildOffDateMap)
    ? window.PrefsUtils.buildOffDateMap(wishDataArr, activeYear, activeMonth)
    : (function(){
        const m = new Map();
        wishDataArr.forEach(w => {
          const shifts = w.data?.shift ?? {};
          const offRaw  = shifts.O;
          if (!offRaw) return;
          let list = Array.isArray(offRaw) ? offRaw : Object.keys(offRaw);
          list = list.map(d => d.includes('-') ? d : `${activeYear}-${String(activeMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
          m.set(w.nurse_id, list);
        });
        return m;
      })();

  /* 2) í…Œì´ë¸” ë¼ˆëŒ€ */
  const daysInMonth = new Date(activeYear, activeMonth, 0).getDate();
  let html = '<table class="wish-table"><thead><tr><th>ê°„í˜¸ì‚¬</th>';
  for (let d = 1; d <= daysInMonth; d++) html += `<th>${d}</th>`;
  html += '</tr></thead><tbody>';

  /* 3) ê°„í˜¸ì‚¬ í–‰ */
  fullNurseSchema.forEach(nurse => {
    const offDates = offMap.get(nurse.nurse_id) || []; // ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´

    html += `<tr>
               <td>${nurse.name}<br><small style="color:#6c757d;">${nurse.experience}ë…„ì°¨</small></td>`;

    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${activeYear}-${String(activeMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const isOff = offDates.includes(dateStr);
      const isHol  = holidayDates.has(dateStr);         // ğŸ†• íœ´ì¼Â·ì£¼ë§?
      const cellClass = isHol ? 'holiday-cell' : '';    // ğŸ†•
      html += `<td class="${cellClass}">${
        isOff
          ? `<div class="wish-cell off-weighted">
                 <div class="shift-marker shift-OFF diagonal" title="OFF"></div>
             </div>`
          : '<div class="wish-cell"></div>'
      }</td>`;
    }
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

        // shift íƒ€ì…ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ë°˜í™˜
        function getShiftClass(shiftType) {
            const upperShift = shiftType.toUpperCase();
            switch(upperShift) {
                case 'D':
                case 'DAY':
                    return 'shift-D';
                case 'E':
                case 'EVENING':
                    return 'shift-E';
                case 'N':
                case 'NIGHT':
                    return 'shift-N';
                case 'O':
                    return 'shift-O';
                default:
                    return 'shift-custom';
            }
        }


        
        // ìº˜ë¦°ë” ì—…ë°ì´íŠ¸
        async function updateCalendar() {
            if (!activeYear || !activeMonth) {
                document.getElementById('calendar-container').style.display = 'none';
                return;
            }
            
            // shifts ë°ì´í„° ë¨¼ì € ë¡œë“œ
            await loadShifts();
            
            // ìº˜ë¦°ë” í•­ìƒ í‘œì‹œí•˜ë„ë¡ ë³€ê²½ (ê¸°ì¡´ ì¡°ê±´ ì œê±°)
            try {
                await loadCalendarData();
                renderShiftSelector();
                renderCalendar();
                document.getElementById('calendar-container').style.display = 'block';
            } catch (error) {
                console.error('ìº˜ë¦°ë” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                document.getElementById('calendar-container').style.display = 'none';
            }
        }
        
        // Shifts ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€
        async function loadShifts() {
            try {
                const response = await fetch('/shifts');
                if (!response.ok) {
                    throw new Error('Shifts ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                availableShifts = await response.json();
                console.log('ë¡œë“œëœ shifts:', availableShifts);
            } catch (error) {
                console.error('Shifts ë¡œë”© ì‹¤íŒ¨:', error);
                // ê¸°ë³¸ shiftsë¡œ fallback
                availableShifts = [
                    {shift_id: 'D', name: 'Day', color: '#87CEEB'},
                    {shift_id: 'E', name: 'Evening', color: '#DDA0DD'},
                    {shift_id: 'N', name: 'Night', color: '#4169E1'},
                    {shift_id: 'O', name: 'Off', color: '#90EE90'}
                ];
            }
        }
        
        // ìº˜ë¦°ë” ì´ˆê¸°í™”
        async function initializeCalendar() {
            // loadShiftsëŠ” updateCalendarì—ì„œ ì´ë¯¸ í˜¸ì¶œë˜ë¯€ë¡œ ì¤‘ë³µ ì œê±°
            console.log('ìº˜ë¦°ë” ì´ˆê¸°í™” ì‹œì‘');
            await loadCalendarData();
            renderShiftSelector();
            renderCalendar();
            console.log('ìº˜ë¦°ë” ì´ˆê¸°í™” ì™„ë£Œ');
        }
        
        // ê¸°ì¡´ ì„ í˜¸ë„ ë°ì´í„°ë¥¼ ìº˜ë¦°ë” ë°ì´í„°ë¡œ ë³€í™˜
        async function loadCalendarData() {
            calendarData = {};
            
            try {
                const response = await fetch(`/preferences/latest?year=${activeYear}&month=${activeMonth}`);
                if (!response.ok) {
                    console.log('ì„ í˜¸ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const data = await response.json();
                if (!data.preference_data || !data.preference_data.shift) {
                    console.log('shift ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ê¸°ì¡´ shift ë°ì´í„°ë¥¼ ìº˜ë¦°ë” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const shifts = data.preference_data.shift;
                for (const [shiftType, dates] of Object.entries(shifts)) {
                    const dateList = Array.isArray(dates) ? dates : Object.keys(dates);
                    for (const dateStr of dateList) {
                        // ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬ ê°œì„ 
                        let formattedDate;
                        if (dateStr.includes('-')) {
                            // ì´ë¯¸ YYYY-MM-DD í˜•ì‹ì¸ ê²½ìš°
                            formattedDate = dateStr;
                        } else {
                            // ë‹¨ìˆœ ì¼ìì¸ ê²½ìš° (ì˜ˆ: "15")
                            const day = parseInt(dateStr);
                            formattedDate = `${activeYear}-${String(activeMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        }
                        console.log('ğŸŸ¡ formattedDate =', formattedDate);
                        console.log('ğŸŸ¡ shiftType =', shiftType);
                        calendarData[formattedDate] = {
                            shift: shiftType,
                            reason: 'ê¸°ì¡´ ë°ì´í„°ì—ì„œ ë¡œë“œë¨'
                        };
                    }
                }
                console.log('ë¡œë“œëœ ìº˜ë¦°ë” ë°ì´í„°:', calendarData);
            } catch (error) {
                console.error('ìº˜ë¦°ë” ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // Shift ì„ íƒê¸° ë Œë”ë§
        function renderShiftSelector() {
            const container = document.getElementById('shift-buttons-container');
            container.innerHTML = '';
            
            availableShifts.forEach(shift => {
                const btn = document.createElement('button');
                btn.className = 'shift-btn';
                btn.textContent = shift.shift_id;
                btn.style.background = shift.color;
                btn.style.color = isLightColor(shift.color) ? '#000' : '#fff';
                btn.onclick = () => selectShift(shift.shift_id);
                
                if (selectedShift === shift.shift_id) {
                    btn.classList.add('selected');
                }
                
                container.appendChild(btn);
            });
        }
        
        // ìƒ‰ìƒì´ ë°ì€ì§€ íŒë‹¨
        function isLightColor(color) {
            const rgb = parseInt(color.slice(1), 16);
            const r = (rgb >> 16) & 0xff;
            const g = (rgb >>  8) & 0xff;
            const b = (rgb >>  0) & 0xff;
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 155;
        }
        
        // Shift ì„ íƒ
        function selectShift(shiftId) {
            selectedShift = shiftId;
            renderShiftSelector(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        }
        
        // ìº˜ë¦°ë” ë Œë”ë§
        function renderCalendar() {
            const title = document.getElementById('calendar-title');
            const tbody = document.getElementById('calendar-body');
            
            title.textContent = `${activeYear}ë…„ ${activeMonth}ì›” í¬ë§ ê·¼ë¬´ ìº˜ë¦°ë”`;
            tbody.innerHTML = '';
            
            const firstDay = new Date(activeYear, activeMonth - 1, 1);
            const lastDay = new Date(activeYear, activeMonth, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            let week = [];
            let currentWeek = document.createElement('tr');
            
            // ì´ì „ ë‹¬ ë‚ ì§œë“¤ë¡œ ì²« ì£¼ ì±„ìš°ê¸°
            for (let i = 0; i < startDay; i++) {
                const td = document.createElement('td');
                td.className = 'other-month';
                const prevDate = new Date(firstDay);
                prevDate.setDate(prevDate.getDate() - (startDay - i));
                td.innerHTML = `<div class="calendar-date">${prevDate.getDate()}</div>`;
                currentWeek.appendChild(td);
            }
            
            // í˜„ì¬ ë‹¬ ë‚ ì§œë“¤
            for (let day = 1; day <= daysInMonth; day++) {
                const td = document.createElement('td');
                const dateStr = `${activeYear}-${String(activeMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                td.innerHTML = `<div class="calendar-date">${day}</div>`;
                td.onclick = () => openModal(dateStr, day);
                
                // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                if (calendarData[dateStr]) {
                    const shift = availableShifts.find(s => s.shift_id === calendarData[dateStr].shift);
                    if (shift) {
                        const marker = document.createElement('div');
                        marker.className = 'calendar-shift-marker';
                        marker.textContent = shift.shift_id;
                        marker.style.background = shift.color;
                        marker.style.color = isLightColor(shift.color) ? '#000' : '#fff';
                        marker.title = calendarData[dateStr].reason;
                        td.querySelector('.calendar-date').appendChild(marker);
                    }
                }
                
                currentWeek.appendChild(td);
                
                // ì£¼ ì™„ì„±ì‹œ í…Œì´ë¸”ì— ì¶”ê°€
                if (currentWeek.children.length === 7) {
                    tbody.appendChild(currentWeek);
                    currentWeek = document.createElement('tr');
                }
            }
            
            // ë‹¤ìŒ ë‹¬ ë‚ ì§œë“¤ë¡œ ë§ˆì§€ë§‰ ì£¼ ì±„ìš°ê¸°
            const remainingCells = 7 - currentWeek.children.length;
            for (let i = 1; i <= remainingCells; i++) {
                const td = document.createElement('td');
                td.className = 'other-month';
                td.innerHTML = `<div class="calendar-date">${i}</div>`;
                currentWeek.appendChild(td);
            }
            
            if (currentWeek.children.length > 0) {
                tbody.appendChild(currentWeek);
            }
        }
        
        // ëª¨ë‹¬ ì—´ê¸°
        function openModal(dateStr, day) {
            modalSelectedDate = dateStr;
            modalSelectedShift = null;
            
            document.getElementById('modal-title').textContent = `${activeYear}ë…„ ${activeMonth}ì›” ${day}ì¼`;
            
            // ëª¨ë‹¬ shift ë²„íŠ¼ë“¤ ë Œë”ë§
            renderModalShifts();
            
            // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì„¤ì •
            if (calendarData[dateStr]) {
                modalSelectedShift = calendarData[dateStr].shift;
                document.getElementById('reason-input').value = calendarData[dateStr].reason || '';
                renderModalShifts(); // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            } else {
                document.getElementById('reason-input').value = '';
            }
            
            document.getElementById('modal-overlay').style.display = 'flex';
        }
        
        // ëª¨ë‹¬ shift ë²„íŠ¼ë“¤ ë Œë”ë§
        function renderModalShifts() {
            const container = document.getElementById('modal-shifts');
            container.innerHTML = '';
            
            availableShifts.forEach(shift => {
                const btn = document.createElement('button');
                btn.className = 'modal-shift-btn';
                btn.textContent = shift.name;
                btn.style.background = shift.color;
                btn.style.color = isLightColor(shift.color) ? '#000' : '#fff';
                btn.onclick = () => selectModalShift(shift.shift_id);
                
                if (modalSelectedShift === shift.shift_id) {
                    btn.classList.add('selected');
                }
                
                container.appendChild(btn);
            });
        }
        
        // ëª¨ë‹¬ì—ì„œ shift ì„ íƒ
        function selectModalShift(shiftId) {
            modalSelectedShift = shiftId;
            renderModalShifts(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            modalSelectedDate = null;
            modalSelectedShift = null;
        }
        
        // ëª¨ë‹¬ í™•ì¸
        function confirmModal() {
            if (!modalSelectedShift) {
                alert('ê·¼ë¬´ ì½”ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const reason = document.getElementById('reason-input').value.trim();
            if (!reason) {
                alert('ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìº˜ë¦°ë” ë°ì´í„°ì— ì €ì¥
            calendarData[modalSelectedDate] = {
                shift: modalSelectedShift,
                reason: reason
            };
            
            // ìº˜ë¦°ë” ë‹¤ì‹œ ë Œë”ë§
            renderCalendar();
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal();
        }
        
        // ìº˜ë¦°ë” ë°ì´í„° ì œì¶œ
        async function submitCalendarData() {
            if (Object.keys(calendarData).length === 0) {
                alert('ì„ íƒëœ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // caseì™€ request ë°°ì—´ êµ¬ì„±
            const cases = [];
            const requests = [];
            
            for (const [dateStr, data] of Object.entries(calendarData)) {
                const date = new Date(dateStr);
                const day = date.getDate();
                
                cases.push({
                    date: dateStr,
                    shift: data.shift
                });
                
                requests.push(`${day}ì¼ì€ ${data.shift}ë¥¼ ì›í•˜ë©° ì´ìœ ëŠ” ${data.reason}ì…ë‹ˆë‹¤`);
            }
            
            // ì „ì²´ ìš”ì²­ í…ìŠ¤íŠ¸ êµ¬ì„±
            // const fullRequest = requests.join('. ');
            const fullRequest = requests;
            
            // submitRequestì™€ ìœ ì‚¬í•œ ë¡œì§ìœ¼ë¡œ ì²˜ë¦¬
            const loader = document.getElementById('cute-loader');
            const resultContainer = document.getElementById('result-container');
            const nurseCharacter = document.getElementById('nurse-character');
            const loadingMessage = document.getElementById('loading-message');
            const loadingSubtitle = document.getElementById('loading-subtitle');
            
            const payload = { 
                request: fullRequest, 
                schema: fullNurseSchema, 
                case: cases 
            };
            
            // result-containerë¥¼ ë¨¼ì € í‘œì‹œí•˜ê³  ê·¸ ì•ˆì— ë¡œë”© í‘œì‹œ
            resultContainer.style.display = 'block';
            loader.style.display = 'flex';
            
            // 1ë‹¨ê³„: ìš”ì²­ ë¶„ì„ì¤‘... (ì¡°ì‚¬í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜)
            nurseCharacter.className = 'nurse-character investigating';
            loadingMessage.textContent = 'ìº˜ë¦°ë” ë°ì´í„° ë¶„ì„ì¤‘...';
            loadingSubtitle.textContent = 'ê³ ì–‘ì´ ê°„í˜¸ì‚¬ê°€ ì¼ì •ì„ ì •ë¦¬í•˜ê³  ìˆì–´ìš”! ğŸ“…';
            
            // ë‹ë³´ê¸° ì¶”ê°€
            const magnifyingGlass = document.createElement('div');
            magnifyingGlass.className = 'magnifying-glass';
            nurseCharacter.appendChild(magnifyingGlass);

            try {
                // 3ì´ˆ í›„ 2ë‹¨ê³„ë¡œ ì „í™˜
                setTimeout(() => {
                    // ë‹ë³´ê¸° ì œê±°
                    const oldMagnifyingGlass = nurseCharacter.querySelector('.magnifying-glass');
                    if (oldMagnifyingGlass) {
                        oldMagnifyingGlass.remove();
                    }
                    
                    // 2ë‹¨ê³„: ìš”ì²­ ì •ë¦¬ì¤‘... (ë¬¸ì„œ ì •ë¦¬í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜)
                    nurseCharacter.className = 'nurse-character organizing';
                    loadingMessage.textContent = 'ìš”ì²­ ì •ë¦¬ì¤‘...';
                    loadingSubtitle.textContent = 'ê³ ì–‘ì´ ê°„í˜¸ì‚¬ê°€ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•˜ê³  ìˆì–´ìš”! ğŸ“‹';
                    
                    // ì„œë¥˜ ì¶”ê°€
                    const papers = document.createElement('div');
                    papers.className = 'papers';
                    papers.innerHTML = '<div class="paper"></div><div class="paper"></div><div class="paper"></div>';
                    nurseCharacter.appendChild(papers);
                }, 3000);

                const response = await fetch('/wanted/invoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                console.log('activeYear:', activeYear, 'activeMonth:', activeMonth);
                console.log('API ì‘ë‹µ ë°ì´í„°:', data);

                if (!activeYear || !activeMonth) {
                    throw new Error('ë…„ë„ì™€ ì›” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ì¼€ì¤„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }

                const preferencePayload = {
                    year: activeYear,
                    month: activeMonth,
                    data: { ...data.response, request: fullRequest }
                };

                console.log('ì „ì†¡í•  ë°ì´í„°:', JSON.stringify(preferencePayload, null, 2));

                const saveResponse = await fetch('/preferences', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(preferencePayload)
                });

                if (!saveResponse.ok) {
                    const errorData = await saveResponse.json();
                    console.error('ì €ì¥ ì—ëŸ¬:', errorData);
                    throw new Error(`ì €ì¥ ì‹¤íŒ¨: ${errorData.detail || saveResponse.statusText}`);
                }

                // ë¡œë”© ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
                loader.style.display = 'none';
                displayResults(preferencePayload.data);
                
                // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œë„ ì—…ë°ì´íŠ¸
                document.getElementById('wanted-input').value = fullRequest;
                
                alert('ìº˜ë¦°ë” ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('Error:', error);
                loader.style.display = 'none';
                document.getElementById('result-display').textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
                setTimeout(() => {
                    // ëª¨ë“  ì¶”ê°€ ìš”ì†Œ ì œê±°
                    const magnifyingGlass = nurseCharacter.querySelector('.magnifying-glass');
                    const papers = nurseCharacter.querySelector('.papers');
                    if (magnifyingGlass) magnifyingGlass.remove();
                    if (papers) papers.remove();
                    
                    // í´ë˜ìŠ¤ ì´ˆê¸°í™”
                    nurseCharacter.className = 'nurse-character';
                }, 500);
            }
        }
    </script>
    <script>
        function toggleNav() {
            const sidebar = document.getElementById("mySidebar");
            const main = document.getElementById("main");
            const toggleBtn = document.querySelector(".sidebar-toggle-btn i");

            const isOpen = sidebar.style.width === "250px";
            if (isOpen) {
                sidebar.style.width = "0";
                main.style.marginLeft = "0";
                toggleBtn.classList.remove('fa-angles-left');
                toggleBtn.classList.add('fa-angles-right');
            } else {
                sidebar.style.width = "250px";
                main.style.marginLeft = "250px";
                toggleBtn.classList.remove('fa-angles-right');
                toggleBtn.classList.add('fa-angles-left');
            }
        }
    </script>
</body>
</html>
